<!doctype html>
<html lang="en" data-bs-theme="auto">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=55843&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><link rel="preload" href="http://localhost:55843/fonts/vendor/jost/jost-v4-latin-regular.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="http://localhost:55843/fonts/vendor/jost/jost-v4-latin-500.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="http://localhost:55843/fonts/vendor/jost/jost-v4-latin-700.woff2" as="font" type="font/woff2" crossorigin>
<script 
  src="/js/color-mode.f14b3e296de1d0b69e75af684b62a4a912a2cadab04e36123407cd8388204f1d.js"
  integrity="sha256-8Us&#43;KW3h0Laeda9oS2KkqRKiytqwTjYSNAfNg4ggTx0=">
</script>


<link rel="stylesheet" href="/main.01b0834d5af51b24812d02878d09c8d7677d6b8af13164fb50215889dc19aaefd0e9366c13b45a9a57ae481dfd1836bce46b5ebfe461d56e3498b9443d8c5e27.css" integrity="sha512-AbCDTVr1GySBLQKHjQnI12d9a4rxMWT7UCFYidwZqu/Q6TZsE7RamleuSB39GDa85Gtev&#43;Rh1W40mLlEPYxeJw==" crossorigin="anonymous">

<noscript><style>img.lazyload { display: none; }</style></noscript><base href="http://localhost:55843/docs/computational_modelling/tutorial/5.-running-the-model-for-multiple-subjects/">
  <link rel="canonical" href="http://localhost:55843/docs/computational_modelling/tutorial/5.-running-the-model-for-multiple-subjects/">
<title>5. Running the model for multiple subjects  |  Wise Lab Wiki</title>
<meta name="description" content="Congrats on setting up a new Doks project!">

    
    <link rel="icon" href="/favicon.ico" sizes="32x32">
    
      <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    
      <link
        rel="apple-touch-icon"
        href="/apple-touch-icon.png"
        sizes="180x180"
        type="image/png"
      >
      <link
        rel="icon"
        href="/favicon-192x192.png"
        sizes="192x192"
        type="image/png"
      >
      <link
        rel="icon"
        href="/favicon-512x512.png"
        sizes="512x512"
        type="image/png"
      >
<link rel="manifest" href="/manifest.webmanifest">
<meta property="og:title" content="5. Running the model for multiple subjects">
<meta property="og:description" content="Updating value across subjects The model we&rsquo;ve implemented so far works for a single subject, but we will typically want to run it for multiple subjects.">
<meta property="og:type" content="article">
<meta property="og:url" content="http://localhost:55843/docs/computational_modelling/tutorial/5.-running-the-model-for-multiple-subjects/"><meta property="og:image" content="http://localhost:55843/cover.png"><meta property="article:section" content="docs">

<meta property="og:site_name" content="My Docs">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://localhost:55843/cover.png"><meta name="twitter:title" content="5. Running the model for multiple subjects">
<meta name="twitter:description" content="Updating value across subjects The model we&rsquo;ve implemented so far works for a single subject, but we will typically want to run it for multiple subjects.">
<meta name="twitter:site" content="@getdoks">

    
    
    
    <script type="application/ld+json">
  {
   "@context": "https://schema.org",
   "@type": "BreadcrumbList",
   "itemListElement": [
     {
       "@type": "ListItem",
       "item": "http://localhost:55843/",
       "name": "Wise Lab Wiki",
       "position": 1
     },
     {
       "@type": "ListItem",
       "item": "http://localhost:55843/docs/",
       "name": "Docs",
       "position": 2
     },
     {
       "@type": "ListItem",
       "item": "http://localhost:55843/docs/computational_modelling/",
       "name": "Computational Modelling",
       "position": 3
     },
     {
       "@type": "ListItem",
       "item": "http://localhost:55843/docs/computational_modelling/tutorial/",
       "name": "Tutorial",
       "position": 4
     },
     {
       "@type": "ListItem",
       "name": "5. Running the Model for Multiple Subjects",
       "position": 5
     }
   ]
 }
</script>



<head>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<script>
  MathJax = {
    tex: {
      displayMath: [['\\[', '\\]'], ['$$', '$$']],  
      inlineMath: [['\\(', '\\)'], ['$', '$']]                  
    }
  };
</script>


</head>


</head>

  
  <body class="single section docs" data-bs-spy="scroll" data-bs-target="#toc" data-bs-root-margin="0px 0px -60%" data-bs-smooth-scroll="true" tabindex="0">
    <div class="sticky-top">
<header class="navbar navbar-expand-lg">
  <div class="container-lg">
  
    <a class="navbar-brand me-auto me-lg-3" href="/">Wise Lab Wiki</a>

    
    
    <button type="button" id="searchToggleMobile" class="btn btn-link nav-link mx-2 d-lg-none" aria-label="Search website">
      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
        <circle cx="10" cy="10" r="7"></circle>
        <line x1="21" y1="21" x2="15" y2="15"></line>
      </svg>
    </button>
    
    <button class="btn btn-link d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavSection" aria-controls="offcanvasNavSection" aria-label="Open section navigation menu">
      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-dots-vertical" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
        <path d="M12 12m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0"></path>
        <path d="M12 19m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0"></path>
        <path d="M12 5m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0"></path>
      </svg>
    </button>
    <div class="offcanvas offcanvas-start d-lg-none" tabindex="-1" id="offcanvasNavSection" aria-labelledby="offcanvasNavSectionLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasNavSectionLabel">Docs</h5>
        <button type="button" class="btn btn-link nav-link p-0 ms-auto" data-bs-dismiss="offcanvas" aria-label="Close">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-x" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
            <path d="M18 6l-12 12"></path>
            <path d="M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="offcanvas-body">
        <aside class="doks-sidebar mt-n3">
          <nav id="doks-docs-nav" aria-label="Tertiary navigation">
            
  
    
<nav class="section-nav docs-links">
  <ul class="list-unstyled">

  <li>
    <details open open>
      <summary>Computational modelling</summary>
      <ul class="list-unstyled list-nested">

  <li>
    <details open>
      <summary>Behavioural Modelling Package</summary>
      <ul class="list-unstyled list-nested">

  <li>
      <a href="/docs/computational_modelling/behavioural_modelling_package/1.-overview/">1. Overview</a>
  </li>
      </ul>
    </details>
  </li>

  <li>
    <details open>
      <summary>Guide</summary>
      <ul class="list-unstyled list-nested">

  <li>
      <a href="/docs/computational_modelling/guide/1.-building-basic-models/">1. Building basic models</a>
  </li>

  <li>
      <a href="/docs/computational_modelling/guide/2.-modelling-multiple-participants/">2. Modelling multiple participants</a>
  </li>

  <li>
      <a href="/docs/computational_modelling/guide/3.-mcmc-sampling/">3. MCMC sampling</a>
  </li>

  <li>
      <a href="/docs/computational_modelling/guide/4.-hierarchical-models/">4. Hierarchical models</a>
  </li>

  <li>
      <a href="/docs/computational_modelling/guide/5.-visualising-mcmc-results/">5. Visualising MCMC results</a>
  </li>

  <li>
      <a href="/docs/computational_modelling/guide/6.-simulation-based-inference/">6. Simulation based inference</a>
  </li>
      </ul>
    </details>
  </li>

  <li>
    <details open open>
      <summary>Tutorial</summary>
      <ul class="list-unstyled list-nested">

  <li>
      <a href="/docs/computational_modelling/tutorial/1.-overview/">1. Overview</a>
  </li>

  <li>
      <a href="/docs/computational_modelling/tutorial/2.-implementing-an-update-function/">2. Implementing an update function</a>
  </li>

  <li>
      <a href="/docs/computational_modelling/tutorial/3.-selecting-actions/">3. Selecting actions</a>
  </li>

  <li>
      <a href="/docs/computational_modelling/tutorial/4.-updating-value-across-trials/">4. Updating value across trials</a>
  </li>

  <li class="active" >
      <a aria-current="page" href="/docs/computational_modelling/tutorial/5.-running-the-model-for-multiple-subjects/">5. Running the model for multiple subjects</a>
  </li>

  <li>
      <a href="/docs/computational_modelling/tutorial/6.-model-fitting-using-mcmc/">6. Model fitting using MCMC</a>
  </li>
      </ul>
    </details>
  </li>

  <li>
      <a href="/docs/computational_modelling/general-best-practices/">General best practices</a>
  </li>
      </ul>
    </details>
  </li>

  <li>
      <a href="/docs/online_experiments/">Online experiments</a>
  </li>
  </ul>
</nav>

  

          </nav>
        </aside>
      </div>
    </div>
    
    <button class="btn btn-link nav-link mx-2 order-3 d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavMain" aria-controls="offcanvasNavMain" aria-label="Open main navigation menu">
      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-menu" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
        <line x1="4" y1="8" x2="20" y2="8"></line>
        <line x1="4" y1="16" x2="20" y2="16"></line>
      </svg>
    </button>

    
    <div class="offcanvas offcanvas-end h-auto" tabindex="-1" id="offcanvasNavMain" aria-labelledby="offcanvasNavMainLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasNavMainLabel">Wise Lab Wiki</h5>
        <button type="button" class="btn btn-link nav-link p-0 ms-auto" data-bs-dismiss="offcanvas" aria-label="Close">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-x" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
            <path d="M18 6l-12 12"></path>
            <path d="M6 6l12 12"></path>
         </svg>
        </button>
      </div>
      
      <div class="offcanvas-body d-flex flex-column flex-lg-row justify-content-between">
        <ul class="navbar-nav flex-grow-1"><li class="nav-item">
                <a class="nav-link active" href="http://localhost:55843/docs/computational_modelling/behavioural_modelling_package/1.-overview" aria-current="true">Docs</a>
              </li>
            </ul>

        
        
        <button type="button" id="searchToggleDesktop" class="btn btn-link nav-link p-2 d-none d-lg-block" aria-label="Search website">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
            <circle cx="10" cy="10" r="7"></circle>
            <line x1="21" y1="21" x2="15" y2="15"></line>
          </svg>
        </button>
        
        
        
        <button id="buttonColorMode" class="btn btn-link mx-auto nav-link p-0 ms-lg-2 me-lg-1" type="button" aria-label="Toggle theme">
          <svg data-bs-theme-value="dark" xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-moon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
            <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
          </svg>
          <svg data-bs-theme-value="light" xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-sun" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
            <path d="M12 12m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0m-5 0h1m8 -9v1m8 8h1m-9 8v1m-6.4 -15.4l.7 .7m12.1 -.7l-.7 .7m0 11.4l.7 .7m-12.1 -.7l-.7 .7"></path>
          </svg>
        </button>
        
        <ul id="socialMenu" class="nav mx-auto flex-row order-lg-4">
          <li class="nav-item">
              <a class="nav-link social-link" href="https://github.com/the-wise-lab"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5"></path></svg><small class="ms-2 visually-hidden">GitHub</small></a>
            </li>
          </ul>
        
        </div>
    </div>

    
    </div>
</header>
</div>

<div class="modal" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-fullscreen-md-down">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5 visually-hidden" id="searchModalLabel">Search</h1>
        <button type="button" class="btn-close visually-hidden" data-bs-dismiss="modal" aria-label="Close"></button>
        <div class="search-input flex-grow-1 d-none">
          <form id="search-form" class="search-form" action="#" method="post" accept-charset="UTF-8" role="search">
            <label for="query" class="visually-hidden">Search</label>
            <div class="d-flex">
              <input type="search" id="query" name="query" class="search-text form-control form-control-lg" placeholder="Search" aria-label="Search" maxlength="128" autocomplete="off">
              <button type="button" class="btn btn-link text-decoration-none px-0 ms-3 d-md-none" data-bs-dismiss="modal" aria-label="Close">Cancel</button>
            </div>
          </form>
        </div>
      </div>
      <div class="modal-body">
        <p class="search-loading status message d-none mt-3 text-center">Loading search index…</p>
        <p class="search-no-recent message d-none mt-3 text-center">No recent searches</p>
        <p class="search-no-results message d-none mt-3 text-center">No results for "<strong><span class="query-no-results">Query here</span></strong>"</p>
        <div id="searchResults" class="search-results"></div>
        <template>
          <article class="search-result list-view">
            <div class="card my-3">
              <div class="card-body">
                <header>
                  <h2 class="h5 title title-submitted mb-0"><a class="stretched-link text-decoration-none text-reset" href="#">Title here</a></h2>
                  <div class="submitted d-none"><time class="created-date">Date here</time></div>
                </header>
                <div class="content">Summary here</div>
              </div>
            </div>
          </article>
        </template>
      </div>
      <div class="modal-footer">
        <ul class="list-inline me-auto d-none d-md-block">
          <li class="list-inline-item"><kbd class="me-2"><svg width="15" height="15" aria-label="Enter key" role="img"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M12 3.53088v3c0 1-1 2-2 2H4M7 11.53088l-3-3 3-3"></path></g></svg></kbd><span class="DocSearch-Label">to select</span></li>
          <li class="list-inline-item"><kbd class="me-2"><svg width="15" height="15" aria-label="Arrow down" role="img"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M7.5 3.5v8M10.5 8.5l-3 3-3-3"></path></g></svg></kbd><kbd class="me-2"><svg width="15" height="15" aria-label="Arrow up" role="img"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M7.5 11.5v-8M10.5 6.5l-3-3-3 3"></path></g></svg></kbd><span class="DocSearch-Label">to navigate</span></li>
          <li class="list-inline-item"><kbd class="me-2"><svg width="15" height="15" aria-label="Escape key" role="img"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M13.6167 8.936c-.1065.3583-.6883.962-1.4875.962-.7993 0-1.653-.9165-1.653-2.1258v-.5678c0-1.2548.7896-2.1016 1.653-2.1016.8634 0 1.3601.4778 1.4875 1.0724M9 6c-.1352-.4735-.7506-.9219-1.46-.8972-.7092.0246-1.344.57-1.344 1.2166s.4198.8812 1.3445.9805C8.465 7.3992 8.968 7.9337 9 8.5c.032.5663-.454 1.398-1.4595 1.398C6.6593 9.898 6 9 5.963 8.4851m-1.4748.5368c-.2635.5941-.8099.876-1.5443.876s-1.7073-.6248-1.7073-2.204v-.4603c0-1.0416.721-2.131 1.7073-2.131.9864 0 1.6425 1.031 1.5443 2.2492h-2.956"></path></g></svg></kbd><span class="DocSearch-Label">to close</span></li>
        </ul>
        <p class="d-md-none">Search by <a class="text-decoration-none" href="https://github.com/nextapps-de/flexsearch">FlexSearch</a></p>
      </div>
    </div>
  </div>
</div>


    <div class="wrap container-lg" role="document">
      <div class="content">
      
        
	<div class="row flex-xl-nowrap">
		<div class="col-lg-5 col-xl-4 docs-sidebar d-none d-lg-block">
			
  
    
<nav class="section-nav docs-links">
  <ul class="list-unstyled">

  <li>
    <details open open>
      <summary>Computational modelling</summary>
      <ul class="list-unstyled list-nested">

  <li>
    <details open>
      <summary>Behavioural Modelling Package</summary>
      <ul class="list-unstyled list-nested">

  <li>
      <a href="/docs/computational_modelling/behavioural_modelling_package/1.-overview/">1. Overview</a>
  </li>
      </ul>
    </details>
  </li>

  <li>
    <details open>
      <summary>Guide</summary>
      <ul class="list-unstyled list-nested">

  <li>
      <a href="/docs/computational_modelling/guide/1.-building-basic-models/">1. Building basic models</a>
  </li>

  <li>
      <a href="/docs/computational_modelling/guide/2.-modelling-multiple-participants/">2. Modelling multiple participants</a>
  </li>

  <li>
      <a href="/docs/computational_modelling/guide/3.-mcmc-sampling/">3. MCMC sampling</a>
  </li>

  <li>
      <a href="/docs/computational_modelling/guide/4.-hierarchical-models/">4. Hierarchical models</a>
  </li>

  <li>
      <a href="/docs/computational_modelling/guide/5.-visualising-mcmc-results/">5. Visualising MCMC results</a>
  </li>

  <li>
      <a href="/docs/computational_modelling/guide/6.-simulation-based-inference/">6. Simulation based inference</a>
  </li>
      </ul>
    </details>
  </li>

  <li>
    <details open open>
      <summary>Tutorial</summary>
      <ul class="list-unstyled list-nested">

  <li>
      <a href="/docs/computational_modelling/tutorial/1.-overview/">1. Overview</a>
  </li>

  <li>
      <a href="/docs/computational_modelling/tutorial/2.-implementing-an-update-function/">2. Implementing an update function</a>
  </li>

  <li>
      <a href="/docs/computational_modelling/tutorial/3.-selecting-actions/">3. Selecting actions</a>
  </li>

  <li>
      <a href="/docs/computational_modelling/tutorial/4.-updating-value-across-trials/">4. Updating value across trials</a>
  </li>

  <li class="active" >
      <a aria-current="page" href="/docs/computational_modelling/tutorial/5.-running-the-model-for-multiple-subjects/">5. Running the model for multiple subjects</a>
  </li>

  <li>
      <a href="/docs/computational_modelling/tutorial/6.-model-fitting-using-mcmc/">6. Model fitting using MCMC</a>
  </li>
      </ul>
    </details>
  </li>

  <li>
      <a href="/docs/computational_modelling/general-best-practices/">General best practices</a>
  </li>
      </ul>
    </details>
  </li>

  <li>
      <a href="/docs/online_experiments/">Online experiments</a>
  </li>
  </ul>
</nav>

  

		</div>
		
		<nav class="docs-toc d-none d-xl-block col-xl-3" aria-label="Secondary navigation">
			<div class="page-links">
  <h3>On this page</h3>
    <nav id="toc">
  <ul>
    <li><a href="#imports">Imports</a></li>
    <li><a href="#functions-from-the-previous-section">Functions from the previous section</a></li>
    <li><a href="#turning-our-existing-code-into-a-function">Turning our existing code into a function</a></li>
    <li><a href="#extending-to-multiple-subjects">Extending to multiple subjects</a>
      <ul>
        <li><a href="#running-the-model-for-multiple-subjects">Running the model for multiple subjects</a></li>
        <li><a href="#extending-further">Extending further</a></li>
      </ul>
    </li>
    <li><a href="#demonstrating-why-jax-is-helpful">Demonstrating why JAX is helpful</a></li>
  </ul>
</nav>
</div>

		</nav>
		<main class="docs-content col-lg-11 col-xl-9 mx-xl-auto">
		
			<h1>5. Running the model for multiple subjects</h1>
			
			<nav class="toc-mobile d-xl-none" aria-label="Quaternary navigation">
				<details>
    <summary>On this page</summary>
    <div class="page-links">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#imports">Imports</a></li>
    <li><a href="#functions-from-the-previous-section">Functions from the previous section</a></li>
    <li><a href="#turning-our-existing-code-into-a-function">Turning our existing code into a function</a></li>
    <li><a href="#extending-to-multiple-subjects">Extending to multiple subjects</a>
      <ul>
        <li><a href="#running-the-model-for-multiple-subjects">Running the model for multiple subjects</a></li>
        <li><a href="#extending-further">Extending further</a></li>
      </ul>
    </li>
    <li><a href="#demonstrating-why-jax-is-helpful">Demonstrating why JAX is helpful</a></li>
  </ul>
</nav>
    </div>
  </details>

			</nav>
			<h1 id="updating-value-across-subjects">Updating value across subjects</h1>
<p>The model we&rsquo;ve implemented so far works for a single subject, but we will typically want to run it for multiple subjects.</p>
<h2 id="imports">Imports<a href="#imports" class="anchor" aria-hidden="true">#</a> </h2>
<p>First, we import necessary packages.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">jax</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">behavioural_modelling.decision_rules</span> <span class="kn">import</span> <span class="n">softmax</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">behavioural_modelling.utils</span> <span class="kn">import</span> <span class="n">choice_from_action_p</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">colormaps</span> <span class="k">as</span> <span class="nn">cmaps</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">font_manager</span><span class="p">,</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Some code to make figures look nicer</span>
</span></span><span class="line"><span class="cl"><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://github.com/google/fonts/blob/main/ofl/heebo/Heebo%5Bwght%5D.ttf?raw=true&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;./Heebo.ttf&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">font_manager</span><span class="o">.</span><span class="n">fontManager</span><span class="o">.</span><span class="n">addfont</span><span class="p">(</span><span class="s1">&#39;./Heebo.ttf&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;lines.linewidth&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;lines.solid_capstyle&#39;</span><span class="p">:</span> <span class="s1">&#39;butt&#39;</span><span class="p">,</span> <span class="s1">&#39;legend.fancybox&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;axes.facecolor&#39;</span><span class="p">:</span> <span class="s1">&#39;fafafa&#39;</span><span class="p">,</span> <span class="s1">&#39;savefig.edgecolor&#39;</span><span class="p">:</span> <span class="s1">&#39;fafafa&#39;</span><span class="p">,</span> <span class="s1">&#39;savefig.facecolor&#39;</span><span class="p">:</span> <span class="s1">&#39;fafafa&#39;</span><span class="p">,</span> <span class="s1">&#39;figure.subplot.left&#39;</span><span class="p">:</span> <span class="mf">0.08</span><span class="p">,</span> <span class="s1">&#39;figure.subplot.right&#39;</span><span class="p">:</span> <span class="mf">0.95</span><span class="p">,</span> <span class="s1">&#39;figure.subplot.bottom&#39;</span><span class="p">:</span> <span class="mf">0.07</span><span class="p">,</span> <span class="s1">&#39;figure.facecolor&#39;</span><span class="p">:</span> <span class="s1">&#39;fafafa&#39;</span><span class="p">,</span> <span class="s1">&#39;figure.dpi&#39;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span> <span class="s1">&#39;lines.color&#39;</span><span class="p">:</span> <span class="s1">&#39;383838&#39;</span><span class="p">,</span> <span class="s1">&#39;patch.edgecolor&#39;</span><span class="p">:</span> <span class="s1">&#39;383838&#39;</span><span class="p">,</span> <span class="s1">&#39;text.color&#39;</span><span class="p">:</span> <span class="s1">&#39;383838&#39;</span><span class="p">,</span> <span class="s1">&#39;axes.edgecolor&#39;</span><span class="p">:</span> <span class="s1">&#39;383838&#39;</span><span class="p">,</span> <span class="s1">&#39;axes.labelcolor&#39;</span><span class="p">:</span> <span class="s1">&#39;383838&#39;</span><span class="p">,</span> <span class="s1">&#39;xtick.color&#39;</span><span class="p">:</span> <span class="s1">&#39;616161&#39;</span><span class="p">,</span> <span class="s1">&#39;ytick.color&#39;</span><span class="p">:</span> <span class="s1">&#39;616161&#39;</span><span class="p">,</span> <span class="s1">&#39;font.family&#39;</span><span class="p">:</span> <span class="s1">&#39;Heebo&#39;</span><span class="p">,</span> <span class="s1">&#39;font.weight&#39;</span><span class="p">:</span> <span class="s1">&#39;regular&#39;</span><span class="p">,</span> <span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;axes.titlesize&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="s1">&#39;axes.labelsize&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;xtick.labelsize&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;ytick.labelsize&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">})</span></span></span></code></pre></div>
  </figure>
</div>
<h2 id="functions-from-the-previous-section">Functions from the previous section<a href="#functions-from-the-previous-section" class="anchor" aria-hidden="true">#</a> </h2>
<p>Here we&rsquo;ll copy the functions we&rsquo;ve implemented in the previous sections.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nd">@jax.jit</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">asymmetric_rescorla_wagner_update</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">value</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">typing</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">outcome</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">typing</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">chosen</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">typing</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">alpha_p</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">alpha_n</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">typing</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">typing</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Updates the estimated value of a state or action using the Asymmetric Rescorla-Wagner learning rule.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    The function calculates the prediction error as the difference between the actual outcome and the current
</span></span></span><span class="line"><span class="cl"><span class="s2">    estimated value. It then updates the estimated value based on the prediction error and the learning rate,
</span></span></span><span class="line"><span class="cl"><span class="s2">    which is determined by whether the prediction error is positive or negative.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Value estimates are only updated for chosen actions. For unchosen actions, the prediction error is set to 0.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">        value (float): The current estimated value of a state or action.
</span></span></span><span class="line"><span class="cl"><span class="s2">        outcome (float): The actual reward received.
</span></span></span><span class="line"><span class="cl"><span class="s2">        chosen (float): Binary indicator of whether the action was chosen (1) or not (0).
</span></span></span><span class="line"><span class="cl"><span class="s2">        alpha_p (float): The learning rate used when the prediction error is positive.
</span></span></span><span class="line"><span class="cl"><span class="s2">        alpha_n (float): The learning rate used when the prediction error is negative.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">        Tuple[float, float]: The updated value and the prediction error.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Calculate the prediction error</span>
</span></span><span class="line"><span class="cl">    <span class="n">prediction_error</span> <span class="o">=</span> <span class="n">outcome</span> <span class="o">-</span> <span class="n">value</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Set prediction error to 0 for unchosen actions</span>
</span></span><span class="line"><span class="cl">    <span class="n">prediction_error</span> <span class="o">=</span> <span class="n">prediction_error</span> <span class="o">*</span> <span class="n">chosen</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Set the learning rate based on the sign of the prediction error</span>
</span></span><span class="line"><span class="cl">    <span class="n">alpha_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">alpha_p</span> <span class="o">*</span> <span class="p">(</span><span class="n">prediction_error</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">alpha_n</span> <span class="o">*</span> <span class="p">(</span><span class="n">prediction_error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Update the value</span>
</span></span><span class="line"><span class="cl">    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span> <span class="o">+</span> <span class="n">alpha_t</span> <span class="o">*</span> <span class="n">prediction_error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">value</span><span class="p">,</span> <span class="n">prediction_error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">asymmetric_rescorla_wagner_update_choice</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">value</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">typing</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">outcome_key</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">typing</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">alpha_p</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">alpha_n</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">n_actions</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Updates the value estimate using the asymmetric Rescorla-Wagner algorithm, and chooses an
</span></span></span><span class="line"><span class="cl"><span class="s2">    option based on the softmax function.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">        value (jax.typing.ArrayLike): The current value estimate.
</span></span></span><span class="line"><span class="cl"><span class="s2">        outcome_key (Tuple[jax.typing.ArrayLike, jax.random.PRNGKey]): A tuple containing the outcome and the PRNG key.
</span></span></span><span class="line"><span class="cl"><span class="s2">        alpha_p (float): The learning rate for positive outcomes.
</span></span></span><span class="line"><span class="cl"><span class="s2">        alpha_n (float): The learning rate for negative outcomes.
</span></span></span><span class="line"><span class="cl"><span class="s2">        temperature (float): The temperature parameter for softmax function.
</span></span></span><span class="line"><span class="cl"><span class="s2">        n_actions (int): The number of actions to choose from.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">        Tuple[np.ndarray, Tuple[jax.typing.ArrayLike, np.ndarray, int, np.ndarray]]:
</span></span></span><span class="line"><span class="cl"><span class="s2">            - updated_value (jnp.ndarray): The updated value estimate.
</span></span></span><span class="line"><span class="cl"><span class="s2">            - output_tuple (Tuple[jax.typing.ArrayLike, np.ndarray, int, np.ndarray]):
</span></span></span><span class="line"><span class="cl"><span class="s2">                - value (jax.typing.ArrayLike): The original value estimate.
</span></span></span><span class="line"><span class="cl"><span class="s2">                - choice_p (jnp.ndarray): The choice probabilities.
</span></span></span><span class="line"><span class="cl"><span class="s2">                - choice (int): The chosen action.
</span></span></span><span class="line"><span class="cl"><span class="s2">                - choice_array (jnp.ndarray): The chosen action in one-hot format.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Unpack outcome and key</span>
</span></span><span class="line"><span class="cl">    <span class="n">outcome</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">outcome_key</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Get choice probabilities</span>
</span></span><span class="line"><span class="cl">    <span class="n">choice_p</span> <span class="o">=</span> <span class="n">softmax</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">temperature</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Get choice</span>
</span></span><span class="line"><span class="cl">    <span class="n">choice</span> <span class="o">=</span> <span class="n">choice_from_action_p</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">choice_p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Convert it to one-hot format</span>
</span></span><span class="line"><span class="cl">    <span class="n">choice_array</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_actions</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">choice_array</span> <span class="o">=</span> <span class="n">choice_array</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Get the outcome and update the value estimate</span>
</span></span><span class="line"><span class="cl">    <span class="n">updated_value</span><span class="p">,</span> <span class="n">prediction_error</span> <span class="o">=</span> <span class="n">asymmetric_rescorla_wagner_update</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">value</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">outcome</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">choice_array</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">alpha_p</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">alpha_n</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">updated_value</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">choice_p</span><span class="p">,</span> <span class="n">choice_array</span><span class="p">,</span> <span class="n">prediction_error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">asymmetric_rescorla_wagner_update_choice</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">asymmetric_rescorla_wagner_update_choice</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,))</span></span></span></code></pre></div>
  </figure>
</div>
<h2 id="turning-our-existing-code-into-a-function">Turning our existing code into a function<a href="#turning-our-existing-code-into-a-function" class="anchor" aria-hidden="true">#</a> </h2>
<p>We had previously written some code to run our update function across multiple trials using <code>jax.lax.scan</code>. Here, we will turn this code into a function that can be called for multiple subjects.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">asymmetric_rescorla_wagner_update_choice_iterator</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">outcomes</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">typing</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">alpha_p</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">alpha_n</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">n_actions</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">key</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Updates the value estimates using the asymmetric Rescorla-Wagner algorithm and generates choices for each trial.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">        outcomes (jax.typing.ArrayLike): The outcomes for each trial.
</span></span></span><span class="line"><span class="cl"><span class="s2">        alpha_p (float): The learning rate for positive outcomes.
</span></span></span><span class="line"><span class="cl"><span class="s2">        alpha_n (float): The learning rate for negative outcomes.
</span></span></span><span class="line"><span class="cl"><span class="s2">        temperature (float): The temperature parameter for the softmax function.
</span></span></span><span class="line"><span class="cl"><span class="s2">        n_actions (int): The number of actions to choose from.
</span></span></span><span class="line"><span class="cl"><span class="s2">        key (jax.random.PRNGKey): The random key.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">        Tuple[jnp.ndarray, jnp.ndarray, jnp.ndarray, jnp.ndarray]:
</span></span></span><span class="line"><span class="cl"><span class="s2">            - values (jnp.ndarray): The value estimates.
</span></span></span><span class="line"><span class="cl"><span class="s2">            - choice_ps (jnp.ndarray): The choice probabilities.
</span></span></span><span class="line"><span class="cl"><span class="s2">            - choices (jnp.ndarray): The chosen actions.
</span></span></span><span class="line"><span class="cl"><span class="s2">            - prediction_errors (jnp.ndarray): The prediction errors.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Use partial to create a function with fixed parameters</span>
</span></span><span class="line"><span class="cl">    <span class="n">asymmetric_rescorla_wagner_update_choice_partial</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">asymmetric_rescorla_wagner_update_choice</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">alpha_p</span><span class="o">=</span><span class="n">alpha_p</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">alpha_n</span><span class="o">=</span><span class="n">alpha_n</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">n_actions</span><span class="o">=</span><span class="n">n_actions</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Generate random keys using JAX</span>
</span></span><span class="line"><span class="cl">    <span class="n">keys</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">N_TRIALS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Initialize the value estimates</span>
</span></span><span class="line"><span class="cl">    <span class="n">value</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Loop using scan</span>
</span></span><span class="line"><span class="cl">    <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">choice_ps</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="n">prediction_errors</span><span class="p">)</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">asymmetric_rescorla_wagner_update_choice_partial</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">value</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">outcomes</span><span class="p">,</span> <span class="n">keys</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">values</span><span class="p">,</span> <span class="n">choice_ps</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="n">prediction_errors</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># JIT</span>
</span></span><span class="line"><span class="cl"><span class="n">asymmetric_rescorla_wagner_update_choice_iterator</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">asymmetric_rescorla_wagner_update_choice_iterator</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,))</span></span></span></code></pre></div>
  </figure>
</div>
<p>We can then use our function as before to simulate data for a single subject.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Number of trials</span>
</span></span><span class="line"><span class="cl"><span class="n">N_TRIALS</span> <span class="o">=</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Reward probabilities for each of our 5 actions</span>
</span></span><span class="line"><span class="cl"><span class="n">reward_probs</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Generate rewards for each trial for each action using Numpy</span>
</span></span><span class="line"><span class="cl"><span class="c1"># There&#39;s no need to use JAX for this</span>
</span></span><span class="line"><span class="cl"><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">rewards</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">reward_probs</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">N_TRIALS</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">reward_probs</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Run the model</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">choice_ps</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="n">prediction_errors</span><span class="p">)</span> <span class="o">=</span> <span class="n">asymmetric_rescorla_wagner_update_choice_iterator</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">outcomes</span><span class="o">=</span><span class="n">rewards</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">alpha_p</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">alpha_n</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">temperature</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">n_actions</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">key</span><span class="o">=</span><span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span></span></span></code></pre></div>
  </figure>
</div>
<h2 id="extending-to-multiple-subjects">Extending to multiple subjects<a href="#extending-to-multiple-subjects" class="anchor" aria-hidden="true">#</a> </h2>
<p>Extending to multiple subjects is straightforward thanks to JAX&rsquo;s vectorization capabilities. We can use the <code>vmap</code> function to run our model for multiple subjects in parallel.</p>
<p>When using <code>vmap</code>, we supply the function we want to run for each subject, and the axis along which we want to run it. For example, if we have a set of trial outcomes represented by a 2-dimensional array where the first dimension indexes the subject and the second dimension indexes the trial, we can run our model for each subject by setting <code>axis=0</code>.</p>
<p>Here, we will create a <code>vmap</code>-ed version of our function. We will assume that the trial outcomes are the same for each subject, and that the parameters are different for each subject.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">asymmetric_rescorla_wagner_update_choice_iterator_vmap</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">asymmetric_rescorla_wagner_update_choice_iterator</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span></span></span></code></pre></div>
  </figure>
</div>
<p>The key part here is the <code>in_axes</code> argument to <code>vmap</code>. This tells JAX which arguments to the function are different across subjects. In our case, the only arguments that change across subjects are the parameters, which are vectors with a single dimensions. We therefore set the corresponding value of <code>in_axes</code> to <code>0</code> for these arguments. The others are set to <code>None</code>, which indicates that they are the same for all subjects.</p>
<h3 id="running-the-model-for-multiple-subjects">Running the model for multiple subjects<a href="#running-the-model-for-multiple-subjects" class="anchor" aria-hidden="true">#</a> </h3>
<p>We can now take our <code>vmap</code>-ed function and run it for multiple subjects. We will simulate data for 40 subjects, each with 100 trials.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Number of subjects</span>
</span></span><span class="line"><span class="cl"><span class="n">N_SUBJECTS</span> <span class="o">=</span> <span class="mi">40</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Generate parameter values for each subject</span>
</span></span><span class="line"><span class="cl"><span class="n">alpha_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">N_SUBJECTS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">alpha_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">N_SUBJECTS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">temperature</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">N_SUBJECTS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Run the model for each subject</span>
</span></span><span class="line"><span class="cl"><span class="c1"># NOTE - this doesn&#39;t work if you pass keyword arguments</span>
</span></span><span class="line"><span class="cl"><span class="n">values</span><span class="p">,</span> <span class="n">choice_ps</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="n">prediction_errors</span> <span class="o">=</span> <span class="n">asymmetric_rescorla_wagner_update_choice_iterator_vmap</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">rewards</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">alpha_p</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">alpha_n</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">temperature</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mi">5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span></span></span></code></pre></div>
  </figure>
</div>
<p>We can then plot the estimated value for a few subjects to see how they learn over time.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Plot the estimated values for the first 3 subjects, one subplot per subject</span>
</span></span><span class="line"><span class="cl"><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>
</span></span><span class="line"><span class="cl">    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Subject </span><span class="si">{</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&#34;Action&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&#34;Estimated Value&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span></span></span></code></pre></div>
  </figure>
</div>
<p>

<img
  src="/docs/computational_modelling/tutorial/Multiple%20subjects_15_0_hu84c4ba79efedb7aaa291851b986fe92b_66835_787x387_resize_q85_h2_lanczos_3.webp"
  width="787"
  height="387"
  decoding="async"
  fetchpriority="auto"
  loading="lazy"
  alt="png"id="h-rh-i-0"
/></p>
<h3 id="extending-further">Extending further<a href="#extending-further" class="anchor" aria-hidden="true">#</a> </h3>
<p>One of the nice things about the <code>vmap</code> functionality is that it is easily to extend. If we wanted to, we could add further dimensions to map across. For example, we could map across blocks of trials, or different conditions. This enables us to use our base update functions flexibly without losing performance.</p>
<p>For example, we could first map across blocks, assuming our <code>outcomes</code> variable is a 2-dimensional array with the shape (n_blocks, n_trials):</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">asymmetric_rescorla_wagner_update_choice_iterator_vmap_blocks</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">asymmetric_rescorla_wagner_update_choice_iterator</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span></span></span></code></pre></div>
  </figure>
</div>
<p>Here, we would set <code>in_axes=(0, None, None, None, None, None)</code> because the first argument (the outcomes) changes across blocks, but the others do not (i.e., the parameter values are the same for each block within each subject).</p>
<p>We could then map this function across subjects as before:</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">asymmetric_rescorla_wagner_update_choice_iterator_vmap_blocks_subjects</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">asymmetric_rescorla_wagner_update_choice_iterator_vmap_blocks</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span></span></span></code></pre></div>
  </figure>
</div>
<h2 id="demonstrating-why-jax-is-helpful">Demonstrating why JAX is helpful<a href="#demonstrating-why-jax-is-helpful" class="anchor" aria-hidden="true">#</a> </h2>
<p>A lot of this imlementation has probably seemed a little convoluted. However, the key advantage of using JAX is that it allows us to write code that is both flexible and efficient. By using <code>vmap</code>, we can write our base update functions in a way that is easy to understand and debug, and then use them in a flexible way without losing performance. This is a powerful feature that is unique to JAX.</p>
<p>Speed isn&rsquo;t necessarily a huge issue when we&rsquo;re dealing with small samples of participants, but we&rsquo;re increasingly using datasets with hundreds of participants or more. In these cases, the efficiency of JAX can be a huge advantage, especially if we&rsquo;re running model fitting procedures that require many iterations (e.g., MCMC sampling).</p>
<p>The vectorised operations we&rsquo;ve used here (using <code>vmap</code>) are much faster than using for loops in Python. These operations can be sped up even further when run on a GPU, which JAX also supports without any need to change the code (if JAX detects a CUDA-compatible GPU, it will automatically run the code on the GPU). This can lead to huge speedups, especially for large datasets.</p>
<p>To demonstrate this, we can compare the speed of our JAX implementation to a naive implementation that uses for loops to iterate over subjects and trials. We&rsquo;ll simulate data for 10000 subjects, each with 100 trials, and compare the speed of the two implementations.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">N_SUBJECTS</span> <span class="o">=</span> <span class="mi">10000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rescorla_wagner_update</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">outcome</span><span class="p">,</span> <span class="n">chosen</span><span class="p">,</span> <span class="n">alpha_p</span><span class="p">,</span> <span class="n">alpha_n</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Calculate the prediction error</span>
</span></span><span class="line"><span class="cl">    <span class="n">prediction_error</span> <span class="o">=</span> <span class="n">outcome</span> <span class="o">-</span> <span class="n">value</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Set unchosen actions to 0</span>
</span></span><span class="line"><span class="cl">    <span class="n">prediction_error</span> <span class="o">=</span> <span class="n">prediction_error</span> <span class="o">*</span> <span class="n">chosen</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Get the alpha for this trial</span>
</span></span><span class="line"><span class="cl">    <span class="n">alpha_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">alpha_p</span> <span class="o">*</span> <span class="p">(</span><span class="n">prediction_error</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">alpha_n</span> <span class="o">*</span> <span class="p">(</span><span class="n">prediction_error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Update the value</span>
</span></span><span class="line"><span class="cl">    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span> <span class="o">+</span> <span class="n">alpha_t</span> <span class="o">*</span> <span class="n">prediction_error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">value</span><span class="p">,</span> <span class="n">prediction_error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">softmax</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">temperature</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Calculate the unnormalized probabilities</span>
</span></span><span class="line"><span class="cl">    <span class="n">unnormalized_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">value</span> <span class="o">/</span> <span class="n">temperature</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Calculate the denominator</span>
</span></span><span class="line"><span class="cl">    <span class="n">normalizing_constant</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">unnormalized_p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Calculate the probabilities</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">=</span> <span class="n">unnormalized_p</span> <span class="o">/</span> <span class="n">normalizing_constant</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">test_pure_python</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">N_SUBJECTS</span><span class="p">,</span> <span class="n">N_TRIALS</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.5</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># RNG</span>
</span></span><span class="line"><span class="cl">    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Generate parameter values for each subject</span>
</span></span><span class="line"><span class="cl">    <span class="n">alpha_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">N_SUBJECTS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">alpha_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">N_SUBJECTS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">temperature</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">N_SUBJECTS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">alpha_p</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">trial</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_TRIALS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Get the value estimate for the current trial</span>
</span></span><span class="line"><span class="cl">            <span class="n">value</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">subject</span><span class="p">,</span> <span class="n">trial</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Get choice probabilities</span>
</span></span><span class="line"><span class="cl">            <span class="n">choice_p</span> <span class="o">=</span> <span class="n">softmax</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">temperature</span><span class="p">[</span><span class="n">subject</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Choose an action</span>
</span></span><span class="line"><span class="cl">            <span class="n">choice</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">p</span><span class="o">=</span><span class="n">choice_p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Convert to one-hot</span>
</span></span><span class="line"><span class="cl">            <span class="n">choice_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">choice_array</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Update the value estimate using the Rescorla-Wagner learning rule</span>
</span></span><span class="line"><span class="cl">            <span class="n">value</span><span class="p">,</span> <span class="n">pe</span> <span class="o">=</span> <span class="n">rescorla_wagner_update</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">rewards</span><span class="p">[</span><span class="n">trial</span><span class="p">],</span> <span class="n">choice_array</span><span class="p">,</span> <span class="n">alpha_p</span><span class="p">[</span><span class="n">subject</span><span class="p">],</span> <span class="n">alpha_n</span><span class="p">[</span><span class="n">subject</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Store the updated value estimate</span>
</span></span><span class="line"><span class="cl">            <span class="n">values</span><span class="p">[</span><span class="n">subject</span><span class="p">,</span> <span class="n">trial</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">test_jax</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Generate parameter values for each subject</span>
</span></span><span class="line"><span class="cl">    <span class="n">alpha_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">N_SUBJECTS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">alpha_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">N_SUBJECTS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">temperature</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">N_SUBJECTS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Run the model for each subject</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># NOTE - this doesn&#39;t work if you pass keyword arguments</span>
</span></span><span class="line"><span class="cl">    <span class="n">values</span><span class="p">,</span> <span class="n">choice_ps</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="n">prediction_errors</span> <span class="o">=</span> <span class="n">asymmetric_rescorla_wagner_update_choice_iterator_vmap</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">rewards</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">alpha_p</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">alpha_n</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">temperature</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span></span></span></code></pre></div>
  </figure>
</div>
<p>First, we&rsquo;ll test the pure Python/Numpy implementation.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%</span><span class="n">time</span> <span class="n">test_pure_python</span><span class="p">()</span></span></span></code></pre></div>
  </figure>
</div>
<pre><code>CPU times: user 25.5 s, sys: 19.3 ms, total: 25.5 s
Wall time: 25.5 s
</code></pre>
<p>And next we&rsquo;ll test the JAX implementation.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%</span><span class="n">time</span> <span class="n">test_jax</span><span class="p">()</span></span></span></code></pre></div>
  </figure>
</div>
<pre><code>CPU times: user 232 ms, sys: 327 ms, total: 559 ms
Wall time: 281 ms
</code></pre>
<p>On my machine, the pure Python/Numpy implementation takes around 25 seconds, while the JAX implementation takes around 0.2 seconds. This is a huge speedup (around 100x), and the difference will be even more pronounced for larger datasets.</p>

			<div class="page-footer-meta d-flex flex-column flex-md-row justify-content-between">
				</div>
			<div class="page-nav d-flex flex-column flex-sm-row">
	
	<div class="card w-100">
			<div class="card-body d-flex">
				<div class="d-flex flex-column justify-content-center">
					<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-arrow-left" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
						<path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
						<path d="M5 12l14 0"></path>
						<path d="M5 12l6 6"></path>
						<path d="M5 12l6 -6"></path>
				 	</svg>
				</div>
				<div class="d-flex flex-column">
					<div class="text-body-secondary">Prev</div>
					<a href="/docs/computational_modelling/tutorial/4.-updating-value-across-trials/" class="stretched-link text-reset text-decoration-none">4. Updating value across trials</a>
				</div>
			</div>
		</div>
	<div class="m-2"></div>
	<div class="card text-end w-100">
			<div class="card-body d-flex justify-content-end">
				<div class="d-flex flex-column">
					<div class="text-body-secondary">Next</div>
					<a href="/docs/computational_modelling/tutorial/6.-model-fitting-using-mcmc/" class="stretched-link text-reset text-decoration-none">6. Model fitting using MCMC</a>
				</div>
				<div class="d-flex flex-column justify-content-center">
					<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-arrow-right" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
						<path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
						<path d="M5 12l14 0"></path>
						<path d="M13 18l6 -6"></path>
						<path d="M13 6l6 6"></path>
					</svg>
				</div>
			</div>
		</div>
	</div>

			
		</main>
		
	</div>

      
      </div>
    </div>
    
    
    <footer class="footer text-muted">
  <div class="container-lg">
    <div class="row">
      <div class="col-lg-8 text-center text-lg-start">
        <ul class="list-inline">
          <li class="list-inline-item"><a class="text-muted" href="/privacy/">Privacy Policy</a></li>
        </ul>
      </div>
      <div class="col-lg-8 text-center text-lg-end">
        <ul class="list-inline">
          <li class="list-inline-item">Brought to you by <a class="text-muted" href="https://gethyas.com/">Hyas</a></li>
        </ul>
      </div>
    </div>
  </div>
</footer>

    

<script async
  src="/js/app.736072d39b5d235f65a5946c43bd62c4c5b279d6100c59644e371f40071bd62d.js"
  integrity="sha256-c2By05tdI19lpZRsQ71ixMWyedYQDFlkTjcfQAcb1i0=">
</script>





<script async
  src="/js/flexsearch.a43ad3e9453067320ab808b85ef437fc65518a219cfea8499e744b7b6f0b6924.js"
  integrity="sha256-pDrT6UUwZzIKuAi4XvQ3/GVRiiGc/qhJnnRLe28LaSQ=">
</script>
<script async
  src="/js/search-modal.543117a85590123cda9e96d1fcbf8bd22fc1a3a3ca3d31a816382f0f10f30a34.js"
  integrity="sha256-VDEXqFWQEjzanpbR/L&#43;L0i/Bo6PKPTGoFjgvDxDzCjQ=">
</script>

    
  </body>
</html>