<!doctype html>
<html lang="en" data-bs-theme="auto">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=55843&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><link rel="preload" href="http://localhost:55843/fonts/vendor/jost/jost-v4-latin-regular.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="http://localhost:55843/fonts/vendor/jost/jost-v4-latin-500.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="http://localhost:55843/fonts/vendor/jost/jost-v4-latin-700.woff2" as="font" type="font/woff2" crossorigin>
<script 
  src="/js/color-mode.f14b3e296de1d0b69e75af684b62a4a912a2cadab04e36123407cd8388204f1d.js"
  integrity="sha256-8Us&#43;KW3h0Laeda9oS2KkqRKiytqwTjYSNAfNg4ggTx0=">
</script>


<link rel="stylesheet" href="/main.01b0834d5af51b24812d02878d09c8d7677d6b8af13164fb50215889dc19aaefd0e9366c13b45a9a57ae481dfd1836bce46b5ebfe461d56e3498b9443d8c5e27.css" integrity="sha512-AbCDTVr1GySBLQKHjQnI12d9a4rxMWT7UCFYidwZqu/Q6TZsE7RamleuSB39GDa85Gtev&#43;Rh1W40mLlEPYxeJw==" crossorigin="anonymous">

<noscript><style>img.lazyload { display: none; }</style></noscript><base href="http://localhost:55843/docs/computational_modelling/tutorial/3.-selecting-actions/">
  <link rel="canonical" href="http://localhost:55843/docs/computational_modelling/tutorial/3.-selecting-actions/">
<title>3. Selecting actions  |  Wise Lab Wiki</title>
<meta name="description" content="Congrats on setting up a new Doks project!">

    
    <link rel="icon" href="/favicon.ico" sizes="32x32">
    
      <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    
      <link
        rel="apple-touch-icon"
        href="/apple-touch-icon.png"
        sizes="180x180"
        type="image/png"
      >
      <link
        rel="icon"
        href="/favicon-192x192.png"
        sizes="192x192"
        type="image/png"
      >
      <link
        rel="icon"
        href="/favicon-512x512.png"
        sizes="512x512"
        type="image/png"
      >
<link rel="manifest" href="/manifest.webmanifest">
<meta property="og:title" content="3. Selecting actions">
<meta property="og:description" content="Selecting actions In most learning tasks we are asking participants to select different actions or stimuli based on their estimated value.">
<meta property="og:type" content="article">
<meta property="og:url" content="http://localhost:55843/docs/computational_modelling/tutorial/3.-selecting-actions/"><meta property="og:image" content="http://localhost:55843/cover.png"><meta property="article:section" content="docs">

<meta property="og:site_name" content="My Docs">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://localhost:55843/cover.png"><meta name="twitter:title" content="3. Selecting actions">
<meta name="twitter:description" content="Selecting actions In most learning tasks we are asking participants to select different actions or stimuli based on their estimated value.">
<meta name="twitter:site" content="@getdoks">

    
    
    
    <script type="application/ld+json">
  {
   "@context": "https://schema.org",
   "@type": "BreadcrumbList",
   "itemListElement": [
     {
       "@type": "ListItem",
       "item": "http://localhost:55843/",
       "name": "Wise Lab Wiki",
       "position": 1
     },
     {
       "@type": "ListItem",
       "item": "http://localhost:55843/docs/",
       "name": "Docs",
       "position": 2
     },
     {
       "@type": "ListItem",
       "item": "http://localhost:55843/docs/computational_modelling/",
       "name": "Computational Modelling",
       "position": 3
     },
     {
       "@type": "ListItem",
       "item": "http://localhost:55843/docs/computational_modelling/tutorial/",
       "name": "Tutorial",
       "position": 4
     },
     {
       "@type": "ListItem",
       "name": "3. Selecting Actions",
       "position": 5
     }
   ]
 }
</script>



<head>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<script>
  MathJax = {
    tex: {
      displayMath: [['\\[', '\\]'], ['$$', '$$']],  
      inlineMath: [['\\(', '\\)'], ['$', '$']]                  
    }
  };
</script>


</head>


</head>

  
  <body class="single section docs" data-bs-spy="scroll" data-bs-target="#toc" data-bs-root-margin="0px 0px -60%" data-bs-smooth-scroll="true" tabindex="0">
    <div class="sticky-top">
<header class="navbar navbar-expand-lg">
  <div class="container-lg">
  
    <a class="navbar-brand me-auto me-lg-3" href="/">Wise Lab Wiki</a>

    
    
    <button type="button" id="searchToggleMobile" class="btn btn-link nav-link mx-2 d-lg-none" aria-label="Search website">
      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
        <circle cx="10" cy="10" r="7"></circle>
        <line x1="21" y1="21" x2="15" y2="15"></line>
      </svg>
    </button>
    
    <button class="btn btn-link d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavSection" aria-controls="offcanvasNavSection" aria-label="Open section navigation menu">
      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-dots-vertical" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
        <path d="M12 12m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0"></path>
        <path d="M12 19m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0"></path>
        <path d="M12 5m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0"></path>
      </svg>
    </button>
    <div class="offcanvas offcanvas-start d-lg-none" tabindex="-1" id="offcanvasNavSection" aria-labelledby="offcanvasNavSectionLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasNavSectionLabel">Docs</h5>
        <button type="button" class="btn btn-link nav-link p-0 ms-auto" data-bs-dismiss="offcanvas" aria-label="Close">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-x" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
            <path d="M18 6l-12 12"></path>
            <path d="M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="offcanvas-body">
        <aside class="doks-sidebar mt-n3">
          <nav id="doks-docs-nav" aria-label="Tertiary navigation">
            
  
    
<nav class="section-nav docs-links">
  <ul class="list-unstyled">

  <li>
    <details open open>
      <summary>Computational modelling</summary>
      <ul class="list-unstyled list-nested">

  <li>
    <details open>
      <summary>Behavioural Modelling Package</summary>
      <ul class="list-unstyled list-nested">

  <li>
      <a href="/docs/computational_modelling/behavioural_modelling_package/1.-overview/">1. Overview</a>
  </li>
      </ul>
    </details>
  </li>

  <li>
    <details open>
      <summary>Guide</summary>
      <ul class="list-unstyled list-nested">

  <li>
      <a href="/docs/computational_modelling/guide/1.-building-basic-models/">1. Building basic models</a>
  </li>

  <li>
      <a href="/docs/computational_modelling/guide/2.-modelling-multiple-participants/">2. Modelling multiple participants</a>
  </li>

  <li>
      <a href="/docs/computational_modelling/guide/3.-mcmc-sampling/">3. MCMC sampling</a>
  </li>

  <li>
      <a href="/docs/computational_modelling/guide/4.-hierarchical-models/">4. Hierarchical models</a>
  </li>

  <li>
      <a href="/docs/computational_modelling/guide/5.-visualising-mcmc-results/">5. Visualising MCMC results</a>
  </li>

  <li>
      <a href="/docs/computational_modelling/guide/6.-simulation-based-inference/">6. Simulation based inference</a>
  </li>
      </ul>
    </details>
  </li>

  <li>
    <details open open>
      <summary>Tutorial</summary>
      <ul class="list-unstyled list-nested">

  <li>
      <a href="/docs/computational_modelling/tutorial/1.-overview/">1. Overview</a>
  </li>

  <li>
      <a href="/docs/computational_modelling/tutorial/2.-implementing-an-update-function/">2. Implementing an update function</a>
  </li>

  <li class="active" >
      <a aria-current="page" href="/docs/computational_modelling/tutorial/3.-selecting-actions/">3. Selecting actions</a>
  </li>

  <li>
      <a href="/docs/computational_modelling/tutorial/4.-updating-value-across-trials/">4. Updating value across trials</a>
  </li>

  <li>
      <a href="/docs/computational_modelling/tutorial/5.-running-the-model-for-multiple-subjects/">5. Running the model for multiple subjects</a>
  </li>

  <li>
      <a href="/docs/computational_modelling/tutorial/6.-model-fitting-using-mcmc/">6. Model fitting using MCMC</a>
  </li>
      </ul>
    </details>
  </li>

  <li>
      <a href="/docs/computational_modelling/general-best-practices/">General best practices</a>
  </li>
      </ul>
    </details>
  </li>

  <li>
      <a href="/docs/online_experiments/">Online experiments</a>
  </li>
  </ul>
</nav>

  

          </nav>
        </aside>
      </div>
    </div>
    
    <button class="btn btn-link nav-link mx-2 order-3 d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavMain" aria-controls="offcanvasNavMain" aria-label="Open main navigation menu">
      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-menu" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
        <line x1="4" y1="8" x2="20" y2="8"></line>
        <line x1="4" y1="16" x2="20" y2="16"></line>
      </svg>
    </button>

    
    <div class="offcanvas offcanvas-end h-auto" tabindex="-1" id="offcanvasNavMain" aria-labelledby="offcanvasNavMainLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasNavMainLabel">Wise Lab Wiki</h5>
        <button type="button" class="btn btn-link nav-link p-0 ms-auto" data-bs-dismiss="offcanvas" aria-label="Close">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-x" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
            <path d="M18 6l-12 12"></path>
            <path d="M6 6l12 12"></path>
         </svg>
        </button>
      </div>
      
      <div class="offcanvas-body d-flex flex-column flex-lg-row justify-content-between">
        <ul class="navbar-nav flex-grow-1"><li class="nav-item">
                <a class="nav-link active" href="http://localhost:55843/docs/computational_modelling/behavioural_modelling_package/1.-overview" aria-current="true">Docs</a>
              </li>
            </ul>

        
        
        <button type="button" id="searchToggleDesktop" class="btn btn-link nav-link p-2 d-none d-lg-block" aria-label="Search website">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
            <circle cx="10" cy="10" r="7"></circle>
            <line x1="21" y1="21" x2="15" y2="15"></line>
          </svg>
        </button>
        
        
        
        <button id="buttonColorMode" class="btn btn-link mx-auto nav-link p-0 ms-lg-2 me-lg-1" type="button" aria-label="Toggle theme">
          <svg data-bs-theme-value="dark" xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-moon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
            <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
          </svg>
          <svg data-bs-theme-value="light" xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-sun" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
            <path d="M12 12m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0m-5 0h1m8 -9v1m8 8h1m-9 8v1m-6.4 -15.4l.7 .7m12.1 -.7l-.7 .7m0 11.4l.7 .7m-12.1 -.7l-.7 .7"></path>
          </svg>
        </button>
        
        <ul id="socialMenu" class="nav mx-auto flex-row order-lg-4">
          <li class="nav-item">
              <a class="nav-link social-link" href="https://github.com/the-wise-lab"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5"></path></svg><small class="ms-2 visually-hidden">GitHub</small></a>
            </li>
          </ul>
        
        </div>
    </div>

    
    </div>
</header>
</div>

<div class="modal" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-fullscreen-md-down">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5 visually-hidden" id="searchModalLabel">Search</h1>
        <button type="button" class="btn-close visually-hidden" data-bs-dismiss="modal" aria-label="Close"></button>
        <div class="search-input flex-grow-1 d-none">
          <form id="search-form" class="search-form" action="#" method="post" accept-charset="UTF-8" role="search">
            <label for="query" class="visually-hidden">Search</label>
            <div class="d-flex">
              <input type="search" id="query" name="query" class="search-text form-control form-control-lg" placeholder="Search" aria-label="Search" maxlength="128" autocomplete="off">
              <button type="button" class="btn btn-link text-decoration-none px-0 ms-3 d-md-none" data-bs-dismiss="modal" aria-label="Close">Cancel</button>
            </div>
          </form>
        </div>
      </div>
      <div class="modal-body">
        <p class="search-loading status message d-none mt-3 text-center">Loading search index…</p>
        <p class="search-no-recent message d-none mt-3 text-center">No recent searches</p>
        <p class="search-no-results message d-none mt-3 text-center">No results for "<strong><span class="query-no-results">Query here</span></strong>"</p>
        <div id="searchResults" class="search-results"></div>
        <template>
          <article class="search-result list-view">
            <div class="card my-3">
              <div class="card-body">
                <header>
                  <h2 class="h5 title title-submitted mb-0"><a class="stretched-link text-decoration-none text-reset" href="#">Title here</a></h2>
                  <div class="submitted d-none"><time class="created-date">Date here</time></div>
                </header>
                <div class="content">Summary here</div>
              </div>
            </div>
          </article>
        </template>
      </div>
      <div class="modal-footer">
        <ul class="list-inline me-auto d-none d-md-block">
          <li class="list-inline-item"><kbd class="me-2"><svg width="15" height="15" aria-label="Enter key" role="img"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M12 3.53088v3c0 1-1 2-2 2H4M7 11.53088l-3-3 3-3"></path></g></svg></kbd><span class="DocSearch-Label">to select</span></li>
          <li class="list-inline-item"><kbd class="me-2"><svg width="15" height="15" aria-label="Arrow down" role="img"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M7.5 3.5v8M10.5 8.5l-3 3-3-3"></path></g></svg></kbd><kbd class="me-2"><svg width="15" height="15" aria-label="Arrow up" role="img"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M7.5 11.5v-8M10.5 6.5l-3-3-3 3"></path></g></svg></kbd><span class="DocSearch-Label">to navigate</span></li>
          <li class="list-inline-item"><kbd class="me-2"><svg width="15" height="15" aria-label="Escape key" role="img"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M13.6167 8.936c-.1065.3583-.6883.962-1.4875.962-.7993 0-1.653-.9165-1.653-2.1258v-.5678c0-1.2548.7896-2.1016 1.653-2.1016.8634 0 1.3601.4778 1.4875 1.0724M9 6c-.1352-.4735-.7506-.9219-1.46-.8972-.7092.0246-1.344.57-1.344 1.2166s.4198.8812 1.3445.9805C8.465 7.3992 8.968 7.9337 9 8.5c.032.5663-.454 1.398-1.4595 1.398C6.6593 9.898 6 9 5.963 8.4851m-1.4748.5368c-.2635.5941-.8099.876-1.5443.876s-1.7073-.6248-1.7073-2.204v-.4603c0-1.0416.721-2.131 1.7073-2.131.9864 0 1.6425 1.031 1.5443 2.2492h-2.956"></path></g></svg></kbd><span class="DocSearch-Label">to close</span></li>
        </ul>
        <p class="d-md-none">Search by <a class="text-decoration-none" href="https://github.com/nextapps-de/flexsearch">FlexSearch</a></p>
      </div>
    </div>
  </div>
</div>


    <div class="wrap container-lg" role="document">
      <div class="content">
      
        
	<div class="row flex-xl-nowrap">
		<div class="col-lg-5 col-xl-4 docs-sidebar d-none d-lg-block">
			
  
    
<nav class="section-nav docs-links">
  <ul class="list-unstyled">

  <li>
    <details open open>
      <summary>Computational modelling</summary>
      <ul class="list-unstyled list-nested">

  <li>
    <details open>
      <summary>Behavioural Modelling Package</summary>
      <ul class="list-unstyled list-nested">

  <li>
      <a href="/docs/computational_modelling/behavioural_modelling_package/1.-overview/">1. Overview</a>
  </li>
      </ul>
    </details>
  </li>

  <li>
    <details open>
      <summary>Guide</summary>
      <ul class="list-unstyled list-nested">

  <li>
      <a href="/docs/computational_modelling/guide/1.-building-basic-models/">1. Building basic models</a>
  </li>

  <li>
      <a href="/docs/computational_modelling/guide/2.-modelling-multiple-participants/">2. Modelling multiple participants</a>
  </li>

  <li>
      <a href="/docs/computational_modelling/guide/3.-mcmc-sampling/">3. MCMC sampling</a>
  </li>

  <li>
      <a href="/docs/computational_modelling/guide/4.-hierarchical-models/">4. Hierarchical models</a>
  </li>

  <li>
      <a href="/docs/computational_modelling/guide/5.-visualising-mcmc-results/">5. Visualising MCMC results</a>
  </li>

  <li>
      <a href="/docs/computational_modelling/guide/6.-simulation-based-inference/">6. Simulation based inference</a>
  </li>
      </ul>
    </details>
  </li>

  <li>
    <details open open>
      <summary>Tutorial</summary>
      <ul class="list-unstyled list-nested">

  <li>
      <a href="/docs/computational_modelling/tutorial/1.-overview/">1. Overview</a>
  </li>

  <li>
      <a href="/docs/computational_modelling/tutorial/2.-implementing-an-update-function/">2. Implementing an update function</a>
  </li>

  <li class="active" >
      <a aria-current="page" href="/docs/computational_modelling/tutorial/3.-selecting-actions/">3. Selecting actions</a>
  </li>

  <li>
      <a href="/docs/computational_modelling/tutorial/4.-updating-value-across-trials/">4. Updating value across trials</a>
  </li>

  <li>
      <a href="/docs/computational_modelling/tutorial/5.-running-the-model-for-multiple-subjects/">5. Running the model for multiple subjects</a>
  </li>

  <li>
      <a href="/docs/computational_modelling/tutorial/6.-model-fitting-using-mcmc/">6. Model fitting using MCMC</a>
  </li>
      </ul>
    </details>
  </li>

  <li>
      <a href="/docs/computational_modelling/general-best-practices/">General best practices</a>
  </li>
      </ul>
    </details>
  </li>

  <li>
      <a href="/docs/online_experiments/">Online experiments</a>
  </li>
  </ul>
</nav>

  

		</div>
		
		<nav class="docs-toc d-none d-xl-block col-xl-3" aria-label="Secondary navigation">
			<div class="page-links">
  <h3>On this page</h3>
    <nav id="toc">
  <ul>
    <li><a href="#imports">Imports</a></li>
    <li><a href="#the-softmax-function">The Softmax function</a>
      <ul>
        <li><a href="#demonstrating-the-softmax-function">Demonstrating the softmax function</a></li>
      </ul>
    </li>
    <li><a href="#choosing-an-action">Choosing an action</a>
      <ul>
        <li><a href="#incorporating-randomness">Incorporating randomness</a></li>
      </ul>
    </li>
    <li><a href="#incorporating-the-softmax-function-into-our-model">Incorporating the softmax function into our model</a>
      <ul>
        <li><a href="#1-inputs-to-the-function">1. Inputs to the function</a></li>
        <li><a href="#2-getting-choice-probabilities-from-values">2. Getting choice probabilities from values</a></li>
        <li><a href="#3-choosing-an-action">3. Choosing an action</a></li>
        <li><a href="#4-converting-to-one-hot-format">4. Converting to one-hot format</a></li>
        <li><a href="#5-updating-the-estimated-value">5. Updating the estimated value</a></li>
        <li><a href="#6-returning-useful-variables">6. Returning useful variables</a></li>
      </ul>
    </li>
    <li><a href="#trying-out-the-function">Trying out the function</a>
      <ul>
        <li><a href="#using-static_argnums">Using <code>static_argnums</code></a></li>
      </ul>
    </li>
  </ul>
</nav>
</div>

		</nav>
		<main class="docs-content col-lg-11 col-xl-9 mx-xl-auto">
		
			<h1>3. Selecting actions</h1>
			
			<nav class="toc-mobile d-xl-none" aria-label="Quaternary navigation">
				<details>
    <summary>On this page</summary>
    <div class="page-links">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#imports">Imports</a></li>
    <li><a href="#the-softmax-function">The Softmax function</a>
      <ul>
        <li><a href="#demonstrating-the-softmax-function">Demonstrating the softmax function</a></li>
      </ul>
    </li>
    <li><a href="#choosing-an-action">Choosing an action</a>
      <ul>
        <li><a href="#incorporating-randomness">Incorporating randomness</a></li>
      </ul>
    </li>
    <li><a href="#incorporating-the-softmax-function-into-our-model">Incorporating the softmax function into our model</a>
      <ul>
        <li><a href="#1-inputs-to-the-function">1. Inputs to the function</a></li>
        <li><a href="#2-getting-choice-probabilities-from-values">2. Getting choice probabilities from values</a></li>
        <li><a href="#3-choosing-an-action">3. Choosing an action</a></li>
        <li><a href="#4-converting-to-one-hot-format">4. Converting to one-hot format</a></li>
        <li><a href="#5-updating-the-estimated-value">5. Updating the estimated value</a></li>
        <li><a href="#6-returning-useful-variables">6. Returning useful variables</a></li>
      </ul>
    </li>
    <li><a href="#trying-out-the-function">Trying out the function</a>
      <ul>
        <li><a href="#using-static_argnums">Using <code>static_argnums</code></a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
  </details>

			</nav>
			<h1 id="selecting-actions">Selecting actions</h1>
<p>In most learning tasks we are asking participants to <em>select</em> different actions or stimuli based on their estimated value. This means that our model not only needs to estimate the value of different options, but also make choices.</p>
<h2 id="imports">Imports<a href="#imports" class="anchor" aria-hidden="true">#</a> </h2>
<p>First, we import necessary packages.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">jax</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span></span></span></code></pre></div>
  </figure>
</div>
<h2 id="the-softmax-function">The Softmax function<a href="#the-softmax-function" class="anchor" aria-hidden="true">#</a> </h2>
<p>The softmax function is a common way to convert values into choice probabilities. It is defined as:</p>
$$
P(a) = \frac{e^{Q(a) / \tau}}{\sum_{a'} e^{Q(a') / \tau}}
$$
<p>where $Q(a)$ is the value of action $a$, and $\tau$ is a parameter that controls the randomness of the choices (referred to as a <em>temperature</em> parameter). When $\tau$ is high, the softmax function will output similar probabilities for all actions, while when $\tau$ is low, the softmax function will output probabilities that are close to 0 or 1.</p>
<p>Essentially, the softmax function calculates the probability of a given action based on its value relative to the values of all other actions. The higher the value of an action, the higher its probability of being selected.</p>
<p>For the sake of simplicity and reproducibility, we&rsquo;ll use an existing implementation of the softmax function from the <code>behavioural_modelling</code> package.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">behavioural_modelling.decision_rules</span> <span class="kn">import</span> <span class="n">softmax</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">?</span><span class="n">softmax</span></span></span></code></pre></div>
  </figure>
</div>
<pre><code>[0;31mSignature:[0m     
[0msoftmax[0m[0;34m([0m[0;34m[0m
[0;34m[0m    [0mvalue[0m[0;34m:[0m [0mUnion[0m[0;34m[[0m[0mnumpy[0m[0;34m.[0m[0m_typing[0m[0;34m.[0m[0m_array_like[0m[0;34m.[0m[0m_SupportsArray[0m[0;34m[[0m[0mnumpy[0m[0;34m.[0m[0mdtype[0m[0;34m[[0m[0mAny[0m[0;34m][0m[0;34m][0m[0;34m,[0m [0mnumpy[0m[0;34m.[0m[0m_typing[0m[0;34m.[0m[0m_nested_sequence[0m[0;34m.[0m[0m_NestedSequence[0m[0;34m[[0m[0mnumpy[0m[0;34m.[0m[0m_typing[0m[0;34m.[0m[0m_array_like[0m[0;34m.[0m[0m_SupportsArray[0m[0;34m[[0m[0mnumpy[0m[0;34m.[0m[0mdtype[0m[0;34m[[0m[0mAny[0m[0;34m][0m[0;34m][0m[0;34m][0m[0;34m,[0m [0mbool[0m[0;34m,[0m [0mint[0m[0;34m,[0m [0mfloat[0m[0;34m,[0m [0mcomplex[0m[0;34m,[0m [0mstr[0m[0;34m,[0m [0mbytes[0m[0;34m,[0m [0mnumpy[0m[0;34m.[0m[0m_typing[0m[0;34m.[0m[0m_nested_sequence[0m[0;34m.[0m[0m_NestedSequence[0m[0;34m[[0m[0mUnion[0m[0;34m[[0m[0mbool[0m[0;34m,[0m [0mint[0m[0;34m,[0m [0mfloat[0m[0;34m,[0m [0mcomplex[0m[0;34m,[0m [0mstr[0m[0;34m,[0m [0mbytes[0m[0;34m][0m[0;34m][0m[0;34m][0m[0;34m,[0m[0;34m[0m
[0;34m[0m    [0mtemperature[0m[0;34m:[0m [0mfloat[0m [0;34m=[0m [0;36m1[0m[0;34m,[0m[0;34m[0m
[0;34m[0m[0;34m)[0m [0;34m-&gt;[0m [0mUnion[0m[0;34m[[0m[0mnumpy[0m[0;34m.[0m[0m_typing[0m[0;34m.[0m[0m_array_like[0m[0;34m.[0m[0m_SupportsArray[0m[0;34m[[0m[0mnumpy[0m[0;34m.[0m[0mdtype[0m[0;34m[[0m[0mAny[0m[0;34m][0m[0;34m][0m[0;34m,[0m [0mnumpy[0m[0;34m.[0m[0m_typing[0m[0;34m.[0m[0m_nested_sequence[0m[0;34m.[0m[0m_NestedSequence[0m[0;34m[[0m[0mnumpy[0m[0;34m.[0m[0m_typing[0m[0;34m.[0m[0m_array_like[0m[0;34m.[0m[0m_SupportsArray[0m[0;34m[[0m[0mnumpy[0m[0;34m.[0m[0mdtype[0m[0;34m[[0m[0mAny[0m[0;34m][0m[0;34m][0m[0;34m][0m[0;34m,[0m [0mbool[0m[0;34m,[0m [0mint[0m[0;34m,[0m [0mfloat[0m[0;34m,[0m [0mcomplex[0m[0;34m,[0m [0mstr[0m[0;34m,[0m [0mbytes[0m[0;34m,[0m [0mnumpy[0m[0;34m.[0m[0m_typing[0m[0;34m.[0m[0m_nested_sequence[0m[0;34m.[0m[0m_NestedSequence[0m[0;34m[[0m[0mUnion[0m[0;34m[[0m[0mbool[0m[0;34m,[0m [0mint[0m[0;34m,[0m [0mfloat[0m[0;34m,[0m [0mcomplex[0m[0;34m,[0m [0mstr[0m[0;34m,[0m [0mbytes[0m[0;34m][0m[0;34m][0m[0;34m][0m[0;34m[0m[0;34m[0m[0m
[0;31mCall signature:[0m [0msoftmax[0m[0;34m([0m[0;34m*[0m[0margs[0m[0;34m,[0m [0;34m**[0m[0mkwargs[0m[0;34m)[0m[0;34m[0m[0;34m[0m[0m
[0;31mType:[0m           PjitFunction
[0;31mString form:[0m    &lt;PjitFunction of &lt;function softmax at 0x7f16777c3be0&gt;&gt;
[0;31mFile:[0m           ~/miniconda3/envs/transition_uncertainty/lib/python3.10/site-packages/behavioural_modelling/decision_rules.py
[0;31mDocstring:[0m     
Softmax function, with optional temperature parameter.

Args:
    value (ArrayLike): Array of values to apply softmax to, of shape (n_trials, n_bandits)
    temperature (float, optional): Softmax temperature, in range 0 &gt; inf. Defaults to 1.

Returns:
    ArrayLike: Choice probabilities, of shape (n_trials, n_bandits)
</code></pre>
<h3 id="demonstrating-the-softmax-function">Demonstrating the softmax function<a href="#demonstrating-the-softmax-function" class="anchor" aria-hidden="true">#</a> </h3>
<p>To demonstrate, we can provide a set of action values and calculate the probabilities of selecting each action according to different temperature parameter values.</p>
<blockquote>
<p><strong>NOTE</strong>: The function expects our values to be 2-dimensional, as we&rsquo;ll often want to apply it to a a set of values for multiple stimuli across multiple trials.</p>
</blockquote>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Initialize the values</span>
</span></span><span class="line"><span class="cl"><span class="n">values</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Example temperature parameter values</span>
</span></span><span class="line"><span class="cl"><span class="n">temperature</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Compute the softmax probabilities using each temperature parameter</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">temperature</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Temperature: </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">softmax</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span></span></span></code></pre></div>
  </figure>
</div>
<pre><code>Temperature: 0.1
[[0. 1. 0.]]
Temperature: 0.5
[[0.12 0.87 0.02]]
Temperature: 0.9
[[0.22999999 0.7        0.08      ]]
</code></pre>
<h2 id="choosing-an-action">Choosing an action<a href="#choosing-an-action" class="anchor" aria-hidden="true">#</a> </h2>
<p>We also want to actually choose an action based on these estimated probabilities. Again, we&rsquo;ll use an existing function for this.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">behavioural_modelling.utils</span> <span class="kn">import</span> <span class="n">choice_from_action_p</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">?</span><span class="n">choice_from_action_p</span></span></span></code></pre></div>
  </figure>
</div>
<pre><code>[0;31mSignature:[0m     
[0mchoice_from_action_p[0m[0;34m([0m[0;34m[0m
[0;34m[0m    [0mkey[0m[0;34m:[0m [0;34m&lt;[0m[0mfunction[0m [0mPRNGKey[0m [0mat[0m [0;36m0x7f160e170700[0m[0;34m&gt;[0m[0;34m,[0m[0;34m[0m
[0;34m[0m    [0mprobs[0m[0;34m:[0m [0mUnion[0m[0;34m[[0m[0mnumpy[0m[0;34m.[0m[0m_typing[0m[0;34m.[0m[0m_array_like[0m[0;34m.[0m[0m_SupportsArray[0m[0;34m[[0m[0mnumpy[0m[0;34m.[0m[0mdtype[0m[0;34m[[0m[0mAny[0m[0;34m][0m[0;34m][0m[0;34m,[0m [0mnumpy[0m[0;34m.[0m[0m_typing[0m[0;34m.[0m[0m_nested_sequence[0m[0;34m.[0m[0m_NestedSequence[0m[0;34m[[0m[0mnumpy[0m[0;34m.[0m[0m_typing[0m[0;34m.[0m[0m_array_like[0m[0;34m.[0m[0m_SupportsArray[0m[0;34m[[0m[0mnumpy[0m[0;34m.[0m[0mdtype[0m[0;34m[[0m[0mAny[0m[0;34m][0m[0;34m][0m[0;34m][0m[0;34m,[0m [0mbool[0m[0;34m,[0m [0mint[0m[0;34m,[0m [0mfloat[0m[0;34m,[0m [0mcomplex[0m[0;34m,[0m [0mstr[0m[0;34m,[0m [0mbytes[0m[0;34m,[0m [0mnumpy[0m[0;34m.[0m[0m_typing[0m[0;34m.[0m[0m_nested_sequence[0m[0;34m.[0m[0m_NestedSequence[0m[0;34m[[0m[0mUnion[0m[0;34m[[0m[0mbool[0m[0;34m,[0m [0mint[0m[0;34m,[0m [0mfloat[0m[0;34m,[0m [0mcomplex[0m[0;34m,[0m [0mstr[0m[0;34m,[0m [0mbytes[0m[0;34m][0m[0;34m][0m[0;34m][0m[0;34m,[0m[0;34m[0m
[0;34m[0m    [0mlapse[0m[0;34m:[0m [0mfloat[0m [0;34m=[0m [0;36m0.0[0m[0;34m,[0m[0;34m[0m
[0;34m[0m[0;34m)[0m [0;34m-&gt;[0m [0mint[0m[0;34m[0m[0;34m[0m[0m
[0;31mCall signature:[0m [0mchoice_from_action_p[0m[0;34m([0m[0;34m*[0m[0margs[0m[0;34m,[0m [0;34m**[0m[0mkwargs[0m[0;34m)[0m[0;34m[0m[0;34m[0m[0m
[0;31mType:[0m           PjitFunction
[0;31mString form:[0m    &lt;PjitFunction of &lt;function choice_from_action_p at 0x7f15fc730310&gt;&gt;
[0;31mFile:[0m           ~/miniconda3/envs/transition_uncertainty/lib/python3.10/site-packages/behavioural_modelling/utils.py
[0;31mDocstring:[0m     
Choose an action from a set of action probabilities. Can take probabilities
in the form of an n-dimensional array, where the last dimension is the
number of actions.

Noise is added to the choice, with probability `lapse`. This means that
on &quot;lapse&quot; trials, the subject will choose an action uniformly at random.

Args:
    key (int): Jax random key
    probs (np.ndarray): N-dimension array of action probabilities, of shape (..., n_actions)
    lapse (float, optional): Probability of lapse. Defaults to 0.0.
Returns:
    int: Chosen action
</code></pre>
<h3 id="incorporating-randomness">Incorporating randomness<a href="#incorporating-randomness" class="anchor" aria-hidden="true">#</a> </h3>
<p>We want to make sure our choices are not deterministic: if we have an action probability of 0.75 this means we&rsquo;ll only want to choose this action 75% of the time. JAX is a little complex when it comes to randomness, and you need to supply a random &ldquo;key&rdquo; every time you want to generate random numbers. This means that when using this function for choosing actions, you&rsquo;ll need to pass in a key as well.</p>
<p>Because we&rsquo;re supplying a random key, the function will <strong>always</strong> return the same action when is given the same key. This is useful for reproducibility, but it also means that you&rsquo;ll need to pass in a new key every time you want to generate a new action.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Get a random key</span>
</span></span><span class="line"><span class="cl"><span class="n">key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Choose an action using the softmax probabilities</span>
</span></span><span class="line"><span class="cl"><span class="n">choice_from_action_p</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">softmax</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span></span></span></code></pre></div>
  </figure>
</div>
<pre><code>Array([1], dtype=int32)
</code></pre>
<h2 id="incorporating-the-softmax-function-into-our-model">Incorporating the softmax function into our model<a href="#incorporating-the-softmax-function-into-our-model" class="anchor" aria-hidden="true">#</a> </h2>
<p>As it stands, we&rsquo;ve implemented a model that can estimate the value of different actions. However, we haven&rsquo;t yet implemented a way to select actions based on these values. We can do this by incorporating the softmax function into our model.</p>
<p>In order to keep our code as modular as possible, we will create a new function (<code>asymmetric_rescorla_wagner_update_choice</code>) that will use our existing update function to estimate the value of different actions, and then use the softmax function to select an action based on these values, rather than integrating this functionality directly into our existing update function.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># THIS IS OUR EXISTING UPDATE FUNCTION</span>
</span></span><span class="line"><span class="cl"><span class="nd">@jax.jit</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">asymmetric_rescorla_wagner_update</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">value</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">typing</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">outcome</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">typing</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">chosen</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">typing</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">alpha_p</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">alpha_n</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">typing</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">typing</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Updates the estimated value of a state or action using the Asymmetric Rescorla-Wagner learning rule.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    The function calculates the prediction error as the difference between the actual outcome and the current
</span></span></span><span class="line"><span class="cl"><span class="s2">    estimated value. It then updates the estimated value based on the prediction error and the learning rate,
</span></span></span><span class="line"><span class="cl"><span class="s2">    which is determined by whether the prediction error is positive or negative.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Value estimates are only updated for chosen actions. For unchosen actions, the prediction error is set to 0.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">        value (float): The current estimated value of a state or action.
</span></span></span><span class="line"><span class="cl"><span class="s2">        outcome (float): The actual reward received.
</span></span></span><span class="line"><span class="cl"><span class="s2">        chosen (float): Binary indicator of whether the action was chosen (1) or not (0).
</span></span></span><span class="line"><span class="cl"><span class="s2">        alpha_p (float): The learning rate used when the prediction error is positive.
</span></span></span><span class="line"><span class="cl"><span class="s2">        alpha_n (float): The learning rate used when the prediction error is negative.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">        Tuple[float, float]: The updated value and the prediction error.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Calculate the prediction error</span>
</span></span><span class="line"><span class="cl">    <span class="n">prediction_error</span> <span class="o">=</span> <span class="n">outcome</span> <span class="o">-</span> <span class="n">value</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Set prediction error to 0 for unchosen actions</span>
</span></span><span class="line"><span class="cl">    <span class="n">prediction_error</span> <span class="o">=</span> <span class="n">prediction_error</span> <span class="o">*</span> <span class="n">chosen</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Set the learning rate based on the sign of the prediction error</span>
</span></span><span class="line"><span class="cl">    <span class="n">alpha_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">alpha_p</span> <span class="o">*</span> <span class="p">(</span><span class="n">prediction_error</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">alpha_n</span> <span class="o">*</span> <span class="p">(</span><span class="n">prediction_error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Update the value</span>
</span></span><span class="line"><span class="cl">    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span> <span class="o">+</span> <span class="n">alpha_t</span> <span class="o">*</span> <span class="n">prediction_error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">value</span><span class="p">,</span> <span class="n">prediction_error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># THIS IS OUR NEW CHOICE FUNCTION</span>
</span></span><span class="line"><span class="cl"><span class="nd">@jax.jit</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">asymmetric_rescorla_wagner_update_choice</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">value</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">typing</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">outcome</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">typing</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">alpha_p</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">alpha_n</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">n_actions</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">key</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Updates the value estimate using the asymmetric Rescorla-Wagner algorithm, and chooses an
</span></span></span><span class="line"><span class="cl"><span class="s2">    option based on the softmax function.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">        value (jax.typing.ArrayLike): The current value estimate.
</span></span></span><span class="line"><span class="cl"><span class="s2">        outcome (jax.typing.ArrayLike): The outcome of the action.
</span></span></span><span class="line"><span class="cl"><span class="s2">        alpha_p (float): The learning rate for positive outcomes.
</span></span></span><span class="line"><span class="cl"><span class="s2">        alpha_n (float): The learning rate for negative outcomes.
</span></span></span><span class="line"><span class="cl"><span class="s2">        temperature (float): The temperature parameter for softmax function.
</span></span></span><span class="line"><span class="cl"><span class="s2">        n_actions (int): The number of actions to choose from.
</span></span></span><span class="line"><span class="cl"><span class="s2">        key (jax.random.PRNGKey): The random key for the choice function.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">        Tuple[np.ndarray, Tuple[jax.typing.ArrayLike, np.ndarray, int, np.ndarray]]:
</span></span></span><span class="line"><span class="cl"><span class="s2">            - updated_value (jnp.ndarray): The updated value estimate.
</span></span></span><span class="line"><span class="cl"><span class="s2">            - output_tuple (Tuple[jax.typing.ArrayLike, np.ndarray, int, np.ndarray]):
</span></span></span><span class="line"><span class="cl"><span class="s2">                - value (jax.typing.ArrayLike): The original value estimate.
</span></span></span><span class="line"><span class="cl"><span class="s2">                - choice_p (jnp.ndarray): The choice probabilities.
</span></span></span><span class="line"><span class="cl"><span class="s2">                - choice (int): The chosen action.
</span></span></span><span class="line"><span class="cl"><span class="s2">                - choice_array (jnp.ndarray): The chosen action in one-hot format.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Get choice probabilities</span>
</span></span><span class="line"><span class="cl">    <span class="n">choice_p</span> <span class="o">=</span> <span class="n">softmax</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">temperature</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Get choice</span>
</span></span><span class="line"><span class="cl">    <span class="n">choice</span> <span class="o">=</span> <span class="n">choice_from_action_p</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">choice_p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Convert it to one-hot format</span>
</span></span><span class="line"><span class="cl">    <span class="n">choice_array</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_actions</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">choice_array</span> <span class="o">=</span> <span class="n">choice_array</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Get the outcome and update the value estimate</span>
</span></span><span class="line"><span class="cl">    <span class="n">updated_value</span><span class="p">,</span> <span class="n">prediction_error</span> <span class="o">=</span> <span class="n">asymmetric_rescorla_wagner_update</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">value</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">choice_array</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">outcome</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">alpha_p</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">alpha_n</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">updated_value</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">choice_p</span><span class="p">,</span> <span class="n">choice_array</span><span class="p">,</span> <span class="n">prediction_error</span><span class="p">)</span></span></span></code></pre></div>
  </figure>
</div>
<p>There is quite a lot going on here, so let&rsquo;s break it down.</p>
<h3 id="1-inputs-to-the-function">1. Inputs to the function<a href="#1-inputs-to-the-function" class="anchor" aria-hidden="true">#</a> </h3>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">asymmetric_rescorla_wagner_update_choice</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">value</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">typing</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">outcome</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">typing</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">chosen</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">typing</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">alpha_p</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">alpha_n</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">n_actions</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">key</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span></span></span></code></pre></div>
  </figure>
</div>
<p>As with our previous function, we provide the current value and the outcome received. Note that we don&rsquo;t need to provide the chosen option as we&rsquo;re generating this from scratch. We also provide the learning rates for positive and negative prediction errors and the temperature parameter for the softmax function.</p>
<p>We also need to provide the number of possible actions. This is because we need to generate a one-hot array of the chosen action, and we need to know how long this array should be. <strong>Why can we not just infer this from the length of the value array using e.g., <code>value.shape</code>?</strong> This is because JAX needs to know the size of the array at compile time, and the size of the value array is not known until runtime. Otherwise, we will get an error when we try to compile the function.</p>
<p>Finally, we need to provide a random key. This is because we&rsquo;re using JAX&rsquo;s random number generator to generate a random choice, and we need to provide a key to do this.</p>
<h3 id="2-getting-choice-probabilities-from-values">2. Getting choice probabilities from values<a href="#2-getting-choice-probabilities-from-values" class="anchor" aria-hidden="true">#</a> </h3>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">choice_p</span> <span class="o">=</span> <span class="n">softmax</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">temperature</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span></span></span></code></pre></div>
  </figure>
</div>
<p>As we mentioned earlier, the softmax function calculates the probability of selecting each action based on its value. We pass in our estimated values for each action, and the temperature parameter, and get back a set of probabilities for selecting each action.</p>
<p>By default, the <code>softmax</code> function expects a 2-dimensional array of values, where the first dimension corresponds to the number of trials and the second dimension corresponds to the number of actions. However, our <code>value</code> array is 1-dimensional as it corresponds to the values or the current trial. We can use the <code>None</code> index to add an extra dimension to our array, and then <code>squeeze</code> to remove it again.</p>
<blockquote>
<p>⚠️ <strong>Note</strong>: It is important that we get choice probabilities and select actions <strong>BEFORE</strong> updating the value. When someone makes a choice on <strong>Trial 1</strong>, they are doing this without having received any information - their choice is based on their current expectation. Only after they have made a choice do they receive feedback, which is then used to update their expectation for the next trial.</p>
</blockquote>
<h3 id="3-choosing-an-action">3. Choosing an action<a href="#3-choosing-an-action" class="anchor" aria-hidden="true">#</a> </h3>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">choice</span> <span class="o">=</span> <span class="n">choice_from_action_p</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">choice_p</span><span class="p">)</span></span></span></code></pre></div>
  </figure>
</div>
<p>As we mentioned earlier, we need to pass in a random key in order to generate a random choice. We use the <code>choice_from_action_p</code> function to generate a random choice based on the probabilities we calculated using the softmax function.</p>
<h3 id="4-converting-to-one-hot-format">4. Converting to one-hot format<a href="#4-converting-to-one-hot-format" class="anchor" aria-hidden="true">#</a> </h3>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">choice_array</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_actions</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">choice_array</span> <span class="o">=</span> <span class="n">choice_array</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></span></span></code></pre></div>
  </figure>
</div>
<p>The <code>choice_from_action_p</code> function returns the index of the chosen action. We convert this index into a one-hot array, where all values are 0 except for the chosen action, which is 1. This is the format that our update function expects.</p>
<h3 id="5-updating-the-estimated-value">5. Updating the estimated value<a href="#5-updating-the-estimated-value" class="anchor" aria-hidden="true">#</a> </h3>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">updated_value</span> <span class="o">=</span> <span class="n">rescorla_wagner_update</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">value</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">choice_array</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">outcomes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">alpha_p</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">alpha_n</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span></span></span></code></pre></div>
  </figure>
</div>
<p>We now update our estimated value based on the chosen action and the outcome of that action. We use the <code>rescorla_wagner_update</code> function that we defined earlier to do this.</p>
<h3 id="6-returning-useful-variables">6. Returning useful variables<a href="#6-returning-useful-variables" class="anchor" aria-hidden="true">#</a> </h3>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">return</span> <span class="n">updated_value</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">choice_p</span><span class="p">,</span> <span class="n">choice_array</span><span class="p">,</span> <span class="n">prediction_error</span><span class="p">)</span></span></span></code></pre></div>
  </figure>
</div>
<p>Finally, we return the updated value, as well as some other useful variables that we might want to keep track of, such as the choice probabilities, the one-hot array of the chosen action, and the prediction error.</p>
<p>This might seem a little odd: <strong>why do we return everything but <code>updated_value</code> as a tuple?</strong> We could instead do something like:</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">return</span> <span class="n">updated_value</span><span class="p">,</span> <span class="n">choice_p</span><span class="p">,</span> <span class="n">choice_array</span><span class="p">,</span> <span class="n">prediction_error</span></span></span></code></pre></div>
  </figure>
</div>
<p>However, we will need to use this function within a <code>jax.lax.scan</code> loop, and <code>jax.lax.scan</code> expects the function to return only two values. The first value is what is fed back into the function at the next time step, and the second value is what is collected at each time step. The only variable that&rsquo;s going to be reused at the next time step is <code>updated_value</code>, so we return this as the first value, and everything else as the second value.</p>
<p>There&rsquo;s something else here that&rsquo;s a bit confusing: <strong>why do we return <code>value</code> as well as <code>updated_value</code>?</strong> We don&rsquo;t actually need to return <code>value</code> here, as we&rsquo;re already returning <code>updated_value</code>. However, we might want to keep track of the value at each time step <strong>before</strong> it has been updated (e.g., perhaps we want to link expected value on a given trial to neural activity, in which case we want the value before it has been updated).</p>
<h2 id="trying-out-the-function">Trying out the function<a href="#trying-out-the-function" class="anchor" aria-hidden="true">#</a> </h2>
<p>If we try to run our function as it&rsquo;s currently written, we will get an error:</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Initialize the value, outcome, choices, and learning rates</span>
</span></span><span class="line"><span class="cl"><span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
</span></span><span class="line"><span class="cl"><span class="n">outcome</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">alpha_p</span> <span class="o">=</span> <span class="mf">0.1</span>
</span></span><span class="line"><span class="cl"><span class="n">alpha_n</span> <span class="o">=</span> <span class="mf">0.9</span>
</span></span><span class="line"><span class="cl"><span class="n">temperature</span> <span class="o">=</span> <span class="mf">0.5</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get a random key</span>
</span></span><span class="line"><span class="cl"><span class="n">key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Call the function</span>
</span></span><span class="line"><span class="cl"><span class="n">updated_value</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">choice_p</span><span class="p">,</span> <span class="n">choice_array</span><span class="p">,</span> <span class="n">prediction_error</span><span class="p">)</span> <span class="o">=</span> <span class="n">asymmetric_rescorla_wagner_update_choice</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">value</span><span class="p">,</span> <span class="n">outcome</span><span class="p">,</span> <span class="n">alpha_p</span><span class="p">,</span> <span class="n">alpha_n</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">key</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Print the results</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Updated Value: </span><span class="si">{</span><span class="n">updated_value</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Prediction Error: </span><span class="si">{</span><span class="n">prediction_error</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span></span></span></code></pre></div>
  </figure>
</div>
<pre><code>---------------------------------------------------------------------------

TypeError                                 Traceback (most recent call last)

Cell In[46], line 12
      9 key = jax.random.PRNGKey(0)
     11 # Call the function
---&gt; 12 updated_value, (value, choice_p, choice_array, prediction_error) = asymmetric_rescorla_wagner_update_choice(
     13     value, outcome, alpha_p, alpha_n, temperature, 5, key
     14 )
     16 # Print the results
     17 print(f&quot;Updated Value: {updated_value}&quot;)


    [... skipping hidden 12 frame]


Cell In[43], line 85, in asymmetric_rescorla_wagner_update_choice(value, outcome, alpha_p, alpha_n, temperature, n_actions, key)
     82 choice = choice_from_action_p(key, choice_p)
     84 # Convert it to one-hot format
---&gt; 85 choice_array = jnp.zeros(n_actions, dtype=jnp.int16)
     86 choice_array = choice_array.at[choice].set(1)
     88 # Get the outcome and update the value estimate


File ~/miniconda3/envs/transition_uncertainty/lib/python3.10/site-packages/jax/_src/numpy/lax_numpy.py:2288, in zeros(shape, dtype)
   2286 if (m := _check_forgot_shape_tuple(&quot;zeros&quot;, shape, dtype)): raise TypeError(m)
   2287 dtypes.check_user_dtype_supported(dtype, &quot;zeros&quot;)
-&gt; 2288 shape = canonicalize_shape(shape)
   2289 return lax.full(shape, 0, _jnp_dtype(dtype))


File ~/miniconda3/envs/transition_uncertainty/lib/python3.10/site-packages/jax/_src/numpy/lax_numpy.py:80, in canonicalize_shape(shape, context)
     77 def canonicalize_shape(shape: Any, context: str=&quot;&quot;) -&gt; core.Shape:
     78   if (not isinstance(shape, (tuple, list)) and
     79       (getattr(shape, 'ndim', None) == 0 or ndim(shape) == 0)):
---&gt; 80     return core.canonicalize_shape((shape,), context)  # type: ignore
     81   else:
     82     return core.canonicalize_shape(shape, context)


File ~/miniconda3/envs/transition_uncertainty/lib/python3.10/site-packages/jax/_src/core.py:2130, in canonicalize_shape(shape, context)
   2128 except TypeError:
   2129   pass
-&gt; 2130 raise _invalid_shape_error(shape, context)


TypeError: Shapes must be 1D sequences of concrete values of integer type, got (Traced&lt;ShapedArray(int32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;,).
If using `jit`, try using `static_argnums` or applying `jit` to smaller subfunctions.
The error occurred while tracing the function asymmetric_rescorla_wagner_update_choice at /tmp/ipykernel_38248/3994267310.py:45 for jit. This concrete value was not available in Python because it depends on the value of the argument n_actions.
</code></pre>
<p>There are various clues in the error message as to what&rsquo;s gone wrong:</p>
<p><code> Shapes must be 1D sequences of concrete values of integer type, got (Traced&lt;ShapedArray(int32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;,).</code></p>
<p><code>If using jit, try using static_argnums</code></p>
<p><code>This concrete value was not available in Python because it depends on the value of the argument n_actions.</code></p>
<p>This is a common problem when using JAX - we need to provide the size of our arrays at compile time, but the size of our arrays is not known until runtime.</p>
<h3 id="using-static_argnums">Using <code>static_argnums</code><a href="#using-static_argnums" class="anchor" aria-hidden="true">#</a> </h3>
<p>Essentially, the problem is that JAX needs to know the shape of everything in advance - this is partly why it can make our code run so quickly. However, in this case, the size of the <code>choice_array</code> variable depends upon the <code>n_actions</code> variable, which is not known until runtime. We&rsquo;ve supplied <code>5</code> here when calling the function, but all JAX sees is an integer that could take any value.</p>
<p>The easiest solution is to tell JAX to compile the function so that it works <em>only</em> with the value that we&rsquo;ve passed in. So we&rsquo;ll get a compiled function that works for <code>n_actions=5</code>, but if we try to use it with <code>n_actions=10</code>, it will fail. This would mean that we need to recomplie the function every time we want to use it with a different number of actions, but in reality that isn&rsquo;t something we&rsquo;re likely to do.</p>
<p>We can do this using the <code>static_argnums</code> argument to <code>jax.jit</code>. This tells JAX that the function should be compiled with respect to the arguments that we specify. In this case, we want to compile the function with respect to the <code>n_actions</code> argument, so we&rsquo;ll pass in <code>5</code> (the index of the <code>n_actions</code> argument in the function signature).</p>
<blockquote>
<p><strong>NOTE</strong>: We need to call <code>jax.jit()</code> as a function rather than using it as a decorator if we want to pass in <code>static_argnums</code>.</p>
</blockquote>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">asymmetric_rescorla_wagner_update_choice</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">value</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">typing</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">outcome</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">typing</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">alpha_p</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">alpha_n</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">n_actions</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">key</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Updates the value estimate using the asymmetric Rescorla-Wagner algorithm, and chooses an
</span></span></span><span class="line"><span class="cl"><span class="s2">    option based on the softmax function.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">        value (jax.typing.ArrayLike): The current value estimate.
</span></span></span><span class="line"><span class="cl"><span class="s2">        outcome (jax.typing.ArrayLike): The outcome of the action.
</span></span></span><span class="line"><span class="cl"><span class="s2">        alpha_p (float): The learning rate for positive outcomes.
</span></span></span><span class="line"><span class="cl"><span class="s2">        alpha_n (float): The learning rate for negative outcomes.
</span></span></span><span class="line"><span class="cl"><span class="s2">        temperature (float): The temperature parameter for softmax function.
</span></span></span><span class="line"><span class="cl"><span class="s2">        n_actions (int): The number of actions to choose from.
</span></span></span><span class="line"><span class="cl"><span class="s2">        key (jax.random.PRNGKey): The random key for the choice function.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">        Tuple[np.ndarray, Tuple[jax.typing.ArrayLike, np.ndarray, int, np.ndarray]]:
</span></span></span><span class="line"><span class="cl"><span class="s2">            - updated_value (jnp.ndarray): The updated value estimate.
</span></span></span><span class="line"><span class="cl"><span class="s2">            - output_tuple (Tuple[jax.typing.ArrayLike, np.ndarray, int, np.ndarray]):
</span></span></span><span class="line"><span class="cl"><span class="s2">                - value (jax.typing.ArrayLike): The original value estimate.
</span></span></span><span class="line"><span class="cl"><span class="s2">                - choice_p (jnp.ndarray): The choice probabilities.
</span></span></span><span class="line"><span class="cl"><span class="s2">                - choice (int): The chosen action.
</span></span></span><span class="line"><span class="cl"><span class="s2">                - choice_array (jnp.ndarray): The chosen action in one-hot format.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Get choice probabilities</span>
</span></span><span class="line"><span class="cl">    <span class="n">choice_p</span> <span class="o">=</span> <span class="n">softmax</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">temperature</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Get choice</span>
</span></span><span class="line"><span class="cl">    <span class="n">choice</span> <span class="o">=</span> <span class="n">choice_from_action_p</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">choice_p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Convert it to one-hot format</span>
</span></span><span class="line"><span class="cl">    <span class="n">choice_array</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_actions</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">choice_array</span> <span class="o">=</span> <span class="n">choice_array</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Get the outcome and update the value estimate</span>
</span></span><span class="line"><span class="cl">    <span class="n">updated_value</span><span class="p">,</span> <span class="n">prediction_error</span> <span class="o">=</span> <span class="n">asymmetric_rescorla_wagner_update</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">value</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">choice_array</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">outcome</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">alpha_p</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">alpha_n</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">updated_value</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">choice_p</span><span class="p">,</span> <span class="n">choice_array</span><span class="p">,</span> <span class="n">prediction_error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">asymmetric_rescorla_wagner_update_choice</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">asymmetric_rescorla_wagner_update_choice</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,))</span></span></span></code></pre></div>
  </figure>
</div>
<p>Now we can try running it again&hellip;</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Initialize the value, outcome, choices, and learning rates</span>
</span></span><span class="line"><span class="cl"><span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
</span></span><span class="line"><span class="cl"><span class="n">outcome</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">alpha_p</span> <span class="o">=</span> <span class="mf">0.1</span>
</span></span><span class="line"><span class="cl"><span class="n">alpha_n</span> <span class="o">=</span> <span class="mf">0.9</span>
</span></span><span class="line"><span class="cl"><span class="n">temperature</span> <span class="o">=</span> <span class="mf">0.5</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get a random key</span>
</span></span><span class="line"><span class="cl"><span class="n">key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Call the function</span>
</span></span><span class="line"><span class="cl"><span class="n">updated_value</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">choice_p</span><span class="p">,</span> <span class="n">choice_array</span><span class="p">,</span> <span class="n">prediction_error</span><span class="p">)</span> <span class="o">=</span> <span class="n">asymmetric_rescorla_wagner_update_choice</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">value</span><span class="p">,</span> <span class="n">outcome</span><span class="p">,</span> <span class="n">alpha_p</span><span class="p">,</span> <span class="n">alpha_n</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">key</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Print the results</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Updated Value: </span><span class="si">{</span><span class="n">updated_value</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Choice probabilities: </span><span class="si">{</span><span class="n">choice_p</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Choice: </span><span class="si">{</span><span class="n">choice_array</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span></span></span></code></pre></div>
  </figure>
</div>
<pre><code>Updated Value: [0.05000001 0.5        0.55       0.5        0.05000001]
Choice probabilities: [0.2 0.2 0.2 0.2 0.2]
Choice: [0 0 1 0 0]
</code></pre>
<p>We can see that the function has chosen action number <code>2</code> (0-indexed), and this is the only action that has had its value updated.</p>

			<div class="page-footer-meta d-flex flex-column flex-md-row justify-content-between">
				</div>
			<div class="page-nav d-flex flex-column flex-sm-row">
	
	<div class="card w-100">
			<div class="card-body d-flex">
				<div class="d-flex flex-column justify-content-center">
					<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-arrow-left" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
						<path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
						<path d="M5 12l14 0"></path>
						<path d="M5 12l6 6"></path>
						<path d="M5 12l6 -6"></path>
				 	</svg>
				</div>
				<div class="d-flex flex-column">
					<div class="text-body-secondary">Prev</div>
					<a href="/docs/computational_modelling/tutorial/2.-implementing-an-update-function/" class="stretched-link text-reset text-decoration-none">2. Implementing an update function</a>
				</div>
			</div>
		</div>
	<div class="m-2"></div>
	<div class="card text-end w-100">
			<div class="card-body d-flex justify-content-end">
				<div class="d-flex flex-column">
					<div class="text-body-secondary">Next</div>
					<a href="/docs/computational_modelling/tutorial/4.-updating-value-across-trials/" class="stretched-link text-reset text-decoration-none">4. Updating value across trials</a>
				</div>
				<div class="d-flex flex-column justify-content-center">
					<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-arrow-right" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
						<path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
						<path d="M5 12l14 0"></path>
						<path d="M13 18l6 -6"></path>
						<path d="M13 6l6 6"></path>
					</svg>
				</div>
			</div>
		</div>
	</div>

			
		</main>
		
	</div>

      
      </div>
    </div>
    
    
    <footer class="footer text-muted">
  <div class="container-lg">
    <div class="row">
      <div class="col-lg-8 text-center text-lg-start">
        <ul class="list-inline">
          <li class="list-inline-item"><a class="text-muted" href="/privacy/">Privacy Policy</a></li>
        </ul>
      </div>
      <div class="col-lg-8 text-center text-lg-end">
        <ul class="list-inline">
          <li class="list-inline-item">Brought to you by <a class="text-muted" href="https://gethyas.com/">Hyas</a></li>
        </ul>
      </div>
    </div>
  </div>
</footer>

    

<script async
  src="/js/app.736072d39b5d235f65a5946c43bd62c4c5b279d6100c59644e371f40071bd62d.js"
  integrity="sha256-c2By05tdI19lpZRsQ71ixMWyedYQDFlkTjcfQAcb1i0=">
</script>





<script async
  src="/js/flexsearch.a43ad3e9453067320ab808b85ef437fc65518a219cfea8499e744b7b6f0b6924.js"
  integrity="sha256-pDrT6UUwZzIKuAi4XvQ3/GVRiiGc/qhJnnRLe28LaSQ=">
</script>
<script async
  src="/js/search-modal.543117a85590123cda9e96d1fcbf8bd22fc1a3a3ca3d31a816382f0f10f30a34.js"
  integrity="sha256-VDEXqFWQEjzanpbR/L&#43;L0i/Bo6PKPTGoFjgvDxDzCjQ=">
</script>

    
  </body>
</html>